{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"themes/material-flow/source/style.less","path":"style.less","modified":0,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.eot","path":"fonts/icomoon.eot","modified":0,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.svg","path":"fonts/icomoon.svg","modified":0,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.ttf","path":"fonts/icomoon.ttf","modified":0,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.woff","path":"fonts/icomoon.woff","modified":0,"renderable":1},{"_id":"themes/material-flow/source/fonts/selection.json","path":"fonts/selection.json","modified":0,"renderable":1},{"_id":"themes/material-flow/source/js/app.js","path":"js/app.js","modified":0,"renderable":1},{"_id":"themes/material-flow/source/js/jquery.fitvids.js","path":"js/jquery.fitvids.js","modified":0,"renderable":1},{"_id":"themes/material-flow/source/js/search.js","path":"js/search.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"d837e5b15386fdb114697ace1f13d298d6e0d1d6","modified":1528692517686},{"_id":"source/baidu_verify_vYMDsKEXTK.html","hash":"8c34dab84b6c369834ba68da7b465394c5400996","modified":1528692517687},{"_id":"themes/material-flow/LICENSE","hash":"44409ab0bcd7853e2ac93faad84e57299711e6bf","modified":1503326312000},{"_id":"themes/material-flow/README.md","hash":"2f14b9c1e7ad23e03da0599a9f348d61c79c474f","modified":1503326312000},{"_id":"themes/material-flow/_config.yml","hash":"b301249b38c4a9140b53824058fc7ecfe3c64705","modified":1503326312000},{"_id":"source/_posts/Go基础语法.md","hash":"e9e8da54e8374ce40060948c49abc4020a7b53de","modified":1528692517687},{"_id":"source/_posts/Go高级编程.md","hash":"5b91b20209d2473185985a8a1ad66d2f335ffd76","modified":1528692517687},{"_id":"source/_posts/Redis实战.md","hash":"01dba6415779874a790efef22c88f488194d9f7b","modified":1528701118425},{"_id":"source/about/index.md","hash":"a3b7feb4535a9726a98902e1b74c75cbcb7a8e03","modified":1528692517687},{"_id":"source/tags/index.md","hash":"f29e949d6b1390fd5724101badfe0519545b6a61","modified":1528692517688},{"_id":"themes/material-flow/layout/archive.ejs","hash":"735e6c0b1f8f837617b3a4119ac321a84f4ec5f7","modified":1503326312000},{"_id":"themes/material-flow/layout/category.ejs","hash":"c97be36b33bb44957778587f00c978f2d28016f8","modified":1503326312000},{"_id":"themes/material-flow/layout/index.ejs","hash":"c97be36b33bb44957778587f00c978f2d28016f8","modified":1503326312000},{"_id":"themes/material-flow/layout/layout.ejs","hash":"c137d708da9c5339dbcdf2e45c4851c08899a457","modified":1503326312000},{"_id":"themes/material-flow/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1503326312000},{"_id":"themes/material-flow/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1503326312000},{"_id":"themes/material-flow/layout/tag.ejs","hash":"c97be36b33bb44957778587f00c978f2d28016f8","modified":1503326312000},{"_id":"themes/material-flow/source/style.less","hash":"ad50444f75534f36001872d4c90e1d839614402b","modified":1503326312000},{"_id":"themes/material-flow/layout/_widget/about.ejs","hash":"3ca212dc0bb83fd9b338920f813667cfc2eda85e","modified":1503326312000},{"_id":"themes/material-flow/layout/_widget/categories.ejs","hash":"2be2c85e4c5275d08e524fabdb38f046054b874a","modified":1503326312000},{"_id":"themes/material-flow/layout/_widget/links.ejs","hash":"2d6c7fc92b0330a7a79b8b680cf9f4286fdf0291","modified":1503326312000},{"_id":"themes/material-flow/layout/_widget/tagcloud.ejs","hash":"914698bcc4210b5f984e12166eca3c86de631968","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/archive.ejs","hash":"7d811a088748b758c0664645629adbebdd8d1c3f","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/article.ejs","hash":"b704e39a37391b8017d1c3ebddcb0e56262c4819","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/categories.ejs","hash":"761fda43c385e81324b628dfab6377b82bfdf82a","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/footer.ejs","hash":"a8d0ee768920a69818e0065a65a94109b72cb77d","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/head.ejs","hash":"e7e1f1b4d9830cf0a91efe6fcbabdbbd405567d0","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/header.ejs","hash":"7ee2448ebb96c206e449ea6641d5ba5cc1a6c9d2","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/loading.ejs","hash":"9c5721d5a5cff00860f2775b12dd73fe62375201","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/post.ejs","hash":"bd3708ff7a0dbd51c48da2eaf47381383b05e9d0","modified":1528694938960},{"_id":"themes/material-flow/layout/_partial/scripts.ejs","hash":"456c65e7c1f93c66511e0976ea88a744d3e6b7de","modified":1503326312000},{"_id":"themes/material-flow/layout/_partial/side.ejs","hash":"fe78dea06ac3a4ce2efcfd6171aea8fb3f64ebe7","modified":1503326312000},{"_id":"themes/material-flow/snapshots/phone.png","hash":"8e78f25ee179e3ff27fff101050792184935d319","modified":1503326312000},{"_id":"themes/material-flow/source/fonts/icomoon.eot","hash":"931a892fd6307c0cfcbb71511ad4a38b3dd20edf","modified":1503326312000},{"_id":"themes/material-flow/source/fonts/icomoon.svg","hash":"37a9d40dfcd7d156cf452db75c425e797351e2b5","modified":1503326312000},{"_id":"themes/material-flow/source/fonts/icomoon.ttf","hash":"6192fb2b38c94f77d1fed08c1969fab5ffe9a30c","modified":1503326312000},{"_id":"themes/material-flow/source/fonts/icomoon.woff","hash":"0356e9be814a04187c641371fd95a7a8d9111200","modified":1503326312000},{"_id":"themes/material-flow/source/fonts/selection.json","hash":"498b5ba0cafb2eb5fa20f9034527eb912fa41827","modified":1503326312000},{"_id":"themes/material-flow/source/js/app.js","hash":"17aca227d841b932ac33af4c9e02a192832fdc85","modified":1503326312000},{"_id":"themes/material-flow/source/js/jquery.fitvids.js","hash":"57946a22c79654014eb00fb548f727d302221873","modified":1503326312000},{"_id":"themes/material-flow/source/less/_archive.less","hash":"0b15989a0d19ce550cf5d0021376c5ad1d4790b9","modified":1503326312000},{"_id":"themes/material-flow/source/js/search.js","hash":"632ce023094442d350dcd2895ca5f948364746cb","modified":1503326312000},{"_id":"themes/material-flow/source/less/_article.less","hash":"37d645669b564df960c02680c0ee6532361b4d7b","modified":1503326312000},{"_id":"themes/material-flow/source/less/_base.less","hash":"828efc946f54ce2bfd5970e1d8d7b08f8f515786","modified":1503326312000},{"_id":"themes/material-flow/source/less/_defines.less","hash":"6b8ffd4e1b478e046722487bae15a500f3fd3092","modified":1503326312000},{"_id":"themes/material-flow/source/less/_fonts.less","hash":"d9e56fa5affcdee1c530ee5d5268a7e07644c05a","modified":1503326312000},{"_id":"themes/material-flow/source/less/_footer.less","hash":"973b1f9c62159f345833db5c30db03c351c66c5c","modified":1503326312000},{"_id":"themes/material-flow/source/less/_header.less","hash":"36f32479c42be1ed503903e1cb88daca5b7792ca","modified":1503326312000},{"_id":"themes/material-flow/source/less/_main.less","hash":"6e2c43e15d1e05bcddbccc1d4830b4687261f1eb","modified":1503326312000},{"_id":"themes/material-flow/source/less/_normalize.less","hash":"02fe53286d071637534d5aa2c57c76c168c0d521","modified":1503326312000},{"_id":"themes/material-flow/source/less/_pagination.less","hash":"165e2c369faf70858b731bb6d483d8991259887e","modified":1503326312000},{"_id":"themes/material-flow/source/less/_search.less","hash":"ab1e3d8fdd489adde30723c40726e5e8187a8b6c","modified":1503326312000},{"_id":"themes/material-flow/source/less/_side.less","hash":"210ffc4e3fc41a5202618e17fc744a8b2b6bc54e","modified":1503326312000},{"_id":"themes/material-flow/source/less/_toc.less","hash":"76729eb95cf89eb17436e13610847102d4795a63","modified":1503326312000},{"_id":"themes/material-flow/source/less/_tog.less","hash":"bff0ab3b06e14a3c171ccd53061f8ccddb1e2fc2","modified":1503326312000},{"_id":"themes/material-flow/source/less/_typo.less","hash":"8635fe95a08614f22833c6c159ebf6cf3d731e12","modified":1503326312000},{"_id":"themes/material-flow/source/less/_widget.less","hash":"a6fc757f2daf58089490eefe0701b9889a8bd4bd","modified":1503326312000},{"_id":"source/_posts/First/logo.png","hash":"3dcb821344fc004c2a87f81cf4b6cf9de213d3a8","modified":1528692517687},{"_id":"themes/material-flow/snapshots/article.png","hash":"3f1aff6057a807b55edd2435421b59a1f4e82c40","modified":1503326312000},{"_id":"themes/material-flow/snapshots/index.png","hash":"a4aa937770d1573032f3e830be3cd75672a26036","modified":1503326312000},{"_id":"public/atom.xml","hash":"361a04ace61016202d8ae69ce6f831d7c4cc4e37","modified":1528701122331},{"_id":"public/content.json","hash":"25dcd1d58094636f9e1fab8e8cbdf1225a1cdf5b","modified":1528807307156},{"_id":"public/search.xml","hash":"ca795d132eac4f49a32bdefe68e5986aea1abef9","modified":1528701122419},{"_id":"public/baidu_verify_vYMDsKEXTK.html","hash":"979762f517d58be82d7410c806ca2dec87547b2d","modified":1528695109702},{"_id":"public/about/index.html","hash":"35f7089c9280829514cc37845d917f140ac18968","modified":1528695109702},{"_id":"public/tags/index.html","hash":"1a60d5e52e78310c557feb713df6e69cf43b364b","modified":1528695109702},{"_id":"public/archives/index.html","hash":"24ed9425a1306f5c409137d5aaceb63deb769735","modified":1528695109702},{"_id":"public/archives/2018/index.html","hash":"9ebd478799f873e0691c9df201b32d9953f6e23a","modified":1528695109702},{"_id":"public/archives/2018/06/index.html","hash":"4d028a346e004b71a6abea9b18441036a30f6914","modified":1528695109702},{"_id":"public/categories/Go语言/index.html","hash":"986c603b101a0caf7b65a469fd5e4d35c2a3b48e","modified":1528695109703},{"_id":"public/categories/Redis/index.html","hash":"482e0994e585ee13e1d92f1856bd017053e1c984","modified":1528695109703},{"_id":"public/index.html","hash":"de3a949d1b6e80e65af31b059ed68203d310ec04","modified":1528695109703},{"_id":"public/tags/Redis/index.html","hash":"cc7dd5c351a956c0c042c56a1cec2af820e4d322","modified":1528695109703},{"_id":"public/tags/技术栈/index.html","hash":"982163fcbd026b4b039a5769567e24149df08da2","modified":1528695109703},{"_id":"public/tags/Go/index.html","hash":"755e957715beef21baf0c663c87f7761fbbf4299","modified":1528695109703},{"_id":"public/Redis实战/index.html","hash":"86bce440cb2baf0f1be52ff1c501852ff55ba1a2","modified":1528701122438},{"_id":"public/Go基础语法/index.html","hash":"f5d39d6e962bf5e1c7032d914fb1af561733121c","modified":1528695109703},{"_id":"public/Go高级编程/index.html","hash":"0702a58701cadc6648f08409fb17c2d2c4889d55","modified":1528695109704}],"Category":[{"name":"Go语言","_id":"cji9tizhq0005b5wxyvmnu8n2"},{"name":"Redis","_id":"cji9tizhv0007b5wxv3hqtpu3"}],"Data":[],"Page":[{"title":"about","date":"2015-12-30T16:32:43.000Z","_content":"","source":"about/index.md","raw":"title: about\ndate: 2015-12-31 00:32:43\n---\n","updated":"2018-06-11T04:48:37.687Z","path":"about/index.html","comments":1,"layout":"page","_id":"cji9tizhk0002b5wxii5oghct","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"tags","date":"2018-06-09T11:54:04.000Z","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2018-06-09 19:54:04\n---\n","updated":"2018-06-11T04:48:37.688Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cji9tizho0004b5wx4l6rk3ub","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"Go基础语法.md","date":"2018-06-09T13:11:17.000Z","_content":" # 编码风格\n## gofmt\n一般会自动规范代码风格\n ##注释&驼峰命名\n/* \n    需要注释的内容\n*/\n## 包名\n```\nimport \"bytes\"\n```\n# 变量\n## 常量\n```\ntype ByteSize float64\nconst (\n\t_           = iota\n\tKB ByteSize = 1 << (2 * iota)\n\tMB\n\tGB\n)\n// 主函数\nfunc main() {\n\tfmt.Println(\"Hello World!\")\n\tfmt.Println(\"size %f\", GB)\n\t// size %f 64\n}\n```\n## 声明\n```\nvar (\n    ErrInternal = errors.New(\"error1\")\n    ErrInternal2 = errors.New(\"error2\")\n)\n```\n## 初始化\nGo语言提供了New和make\n### new\n```\n// 0值初始化\ntype SyncedBuffer struct {\n    lock sync.Mutex\n    buffer bytes.Buffer\n}\np := new(SyncedBuffer)     // type *SyncedBuffer\nvar v SyncedBuffer            // type SyncedBuffer\n\n// 如果是构造函数\nfunc NewFile(fd int, name string) *File {\n    if fd < 0 {\n        return nil\n    }\n    f := File{fd, name, nil, 0} // 如果不按顺序，就需要加名字\n    return &f\n}\n// 复合字面可以初始化多种结构\na := [...]string {Enone: \"no error\", Eio: \"Eio\", Einval: \"invalid argument\"}\ns := []string {Enone: \"no error\", Eio: \"Eio\", Einval: \"invalid argument\"}\nm := map[int]string {Enone: \"no error\", Eio: \"Eio\", Einval: \"invalid argument\"}\n```\n### make\n`make一般用于初始化切片，映射，信道\n```\nmake([]int, 10, 100)\n// 一般用法, 返回的不是指针\nv := make([]int, 100) \n```\n# 分支循环\n## if\n```\nif i < f() {\n    g()\n}\n\nif err := file.Chmod(0664); err != nil {\n    log.Print(err)\n    return err\n}\n```\n## for\n```\nfor init; condition; post {}\nfor condition {}\nfor {}\n// 举例\nsum := 0\nfor i := 0; i < 10; i++ {\n    sum += i\n}\n// 遍历复合结构\nfor key, value := range oldMap {\n    newMap[key] = value\n}\n// 只遍历第一个\nfor key := range oldMap {\n}\n// 只遍历第二个\nfor _, value := range array {\n}\n// 遍历字符串\nfor pos, char := range \"日本 \\ x80 语\" {\n    fmt.Printf()\n}\n// 反转数字\nfor i, j := 0, len(a) - 1; i < j; i,j = i+1, j-1 {\n    a[i], a[j] = a[j], a[i]\n}\n```\n## switch\n```\nswitch {\ncase '0' <= c && c <= '9' :\n    return c - '0'\ncase 'a' <= c && c <= 'f' :\n    return c - 'a' + 10\n}\n// 处理相同条件\nswitch c {\ncase 'a', 'b', 'c':\n    return true\n}\n// 判断类型\nvar t interface{}\nt = getType()\nswitch t := t.(type) {\ndefault :\n    fmt.Printf(\"%T\", t)\ncase bool :\n    fmt.Printf(\"boolean %t\\n\", t)\ncase int:\n    fmt.Printf(\"integer %d\\n\", t)\n}\n```\n# 函数\n## 多值返回\n```\nfunc (file *File) Write(b []byte) (n int, err error)\n```\n## defer\n无论何种路径都能返回，如果定义多个按定义顺序相反顺序执行\n# 切片(数组)\n```\n// 切片是按值传递，但是底层可能是同一份数组\n// 二维切片\ntype Transform [3][3]float64\ntype LinesOfText [][]byte\ntest := LinesOfTest{\n    []byte(\"abc\"),\n    []byte(\"abc\"),\n    []byte(\"abc\"),\n}\n```\n## append\n```\n// 增加元素\nx := []int{1,2,3}\nx = append(x, 4, 5, 6)\nfmt.Println(x)\n// 增加切片\ny := []int{1,2,3}\nx = append(x, y...)\nfmt.Println(x)\n```\n# Map映射\n```\nattend := map[string]bool{\n    \"Ann\" : true,\n    \"Joe\" : true,\n    ...\n}\n// 判断是否存在\nvar seconds int\nvar ok bool\nseconds, ok = timeZone[tz]\nif _, ok := timeZone[tz]; ok {\n    doSomething()\n}\n// 删除映射\ndelete(timeZone, \"PDT\")\n```\n初始化方式：\nFile{fd, name, nil, 0}\nFile{fd: fd, name: name}\nmake([]int, 100)\n# 函数\n## init\n在变量初始化之后，导入包初始化之后，就会初始化\n`以指针或值为接收者的区别在于：值方法可通过指针和值调用， 而指针方法只能通过指针来调用。\n# 接口\n## 断言\n```\nstr, ok := value.(string)\nif ok {\n    fmt.Printf(\"\")\n} else {\n}\n```\n## 内嵌\n```\n// 接口\ntype Reader interface {\n    Read(p []byte) (n int, err error)\n}\n\ntype Writer interface {\n    Write(p []byte) (n int, err error)\n}\ntype ReaderWriter interface {\n    Reader\n    Writer\n}\n// 结构体\ntype ReaderWriter struct {\n    *Reader\n    *Writer\n}\n```\n# 并发\n## chan\n```\ncj := make(chan int)                // 无缓冲信道\ncj := make(chan int, 0)            // 无缓冲信道\ncj := make(chan *os.File, 100) // 指向文件指针的带缓冲信道\n```\n## 例子\n```\nc := make(chan int)\ngo func() {\n    list.Sort()\n    c <- 1\n}()\ndoSomethingForAWhile()\n<- c\n\n// 考虑带缓冲的任务\nfunc Serve(queue chan *Request) {\n       for req := range queue {\n            req := req\n           sem <- 1\n            go func() {\n                process(req)\n                <-sem\n            }()\n        }\n}\n```\n# panic&recover\n","source":"_posts/Go基础语法.md","raw":"---\ntitle: Go基础语法.md\ndate: 2018-06-09 21:11:17\ncategories: Go语言\n---\n # 编码风格\n## gofmt\n一般会自动规范代码风格\n ##注释&驼峰命名\n/* \n    需要注释的内容\n*/\n## 包名\n```\nimport \"bytes\"\n```\n# 变量\n## 常量\n```\ntype ByteSize float64\nconst (\n\t_           = iota\n\tKB ByteSize = 1 << (2 * iota)\n\tMB\n\tGB\n)\n// 主函数\nfunc main() {\n\tfmt.Println(\"Hello World!\")\n\tfmt.Println(\"size %f\", GB)\n\t// size %f 64\n}\n```\n## 声明\n```\nvar (\n    ErrInternal = errors.New(\"error1\")\n    ErrInternal2 = errors.New(\"error2\")\n)\n```\n## 初始化\nGo语言提供了New和make\n### new\n```\n// 0值初始化\ntype SyncedBuffer struct {\n    lock sync.Mutex\n    buffer bytes.Buffer\n}\np := new(SyncedBuffer)     // type *SyncedBuffer\nvar v SyncedBuffer            // type SyncedBuffer\n\n// 如果是构造函数\nfunc NewFile(fd int, name string) *File {\n    if fd < 0 {\n        return nil\n    }\n    f := File{fd, name, nil, 0} // 如果不按顺序，就需要加名字\n    return &f\n}\n// 复合字面可以初始化多种结构\na := [...]string {Enone: \"no error\", Eio: \"Eio\", Einval: \"invalid argument\"}\ns := []string {Enone: \"no error\", Eio: \"Eio\", Einval: \"invalid argument\"}\nm := map[int]string {Enone: \"no error\", Eio: \"Eio\", Einval: \"invalid argument\"}\n```\n### make\n`make一般用于初始化切片，映射，信道\n```\nmake([]int, 10, 100)\n// 一般用法, 返回的不是指针\nv := make([]int, 100) \n```\n# 分支循环\n## if\n```\nif i < f() {\n    g()\n}\n\nif err := file.Chmod(0664); err != nil {\n    log.Print(err)\n    return err\n}\n```\n## for\n```\nfor init; condition; post {}\nfor condition {}\nfor {}\n// 举例\nsum := 0\nfor i := 0; i < 10; i++ {\n    sum += i\n}\n// 遍历复合结构\nfor key, value := range oldMap {\n    newMap[key] = value\n}\n// 只遍历第一个\nfor key := range oldMap {\n}\n// 只遍历第二个\nfor _, value := range array {\n}\n// 遍历字符串\nfor pos, char := range \"日本 \\ x80 语\" {\n    fmt.Printf()\n}\n// 反转数字\nfor i, j := 0, len(a) - 1; i < j; i,j = i+1, j-1 {\n    a[i], a[j] = a[j], a[i]\n}\n```\n## switch\n```\nswitch {\ncase '0' <= c && c <= '9' :\n    return c - '0'\ncase 'a' <= c && c <= 'f' :\n    return c - 'a' + 10\n}\n// 处理相同条件\nswitch c {\ncase 'a', 'b', 'c':\n    return true\n}\n// 判断类型\nvar t interface{}\nt = getType()\nswitch t := t.(type) {\ndefault :\n    fmt.Printf(\"%T\", t)\ncase bool :\n    fmt.Printf(\"boolean %t\\n\", t)\ncase int:\n    fmt.Printf(\"integer %d\\n\", t)\n}\n```\n# 函数\n## 多值返回\n```\nfunc (file *File) Write(b []byte) (n int, err error)\n```\n## defer\n无论何种路径都能返回，如果定义多个按定义顺序相反顺序执行\n# 切片(数组)\n```\n// 切片是按值传递，但是底层可能是同一份数组\n// 二维切片\ntype Transform [3][3]float64\ntype LinesOfText [][]byte\ntest := LinesOfTest{\n    []byte(\"abc\"),\n    []byte(\"abc\"),\n    []byte(\"abc\"),\n}\n```\n## append\n```\n// 增加元素\nx := []int{1,2,3}\nx = append(x, 4, 5, 6)\nfmt.Println(x)\n// 增加切片\ny := []int{1,2,3}\nx = append(x, y...)\nfmt.Println(x)\n```\n# Map映射\n```\nattend := map[string]bool{\n    \"Ann\" : true,\n    \"Joe\" : true,\n    ...\n}\n// 判断是否存在\nvar seconds int\nvar ok bool\nseconds, ok = timeZone[tz]\nif _, ok := timeZone[tz]; ok {\n    doSomething()\n}\n// 删除映射\ndelete(timeZone, \"PDT\")\n```\n初始化方式：\nFile{fd, name, nil, 0}\nFile{fd: fd, name: name}\nmake([]int, 100)\n# 函数\n## init\n在变量初始化之后，导入包初始化之后，就会初始化\n`以指针或值为接收者的区别在于：值方法可通过指针和值调用， 而指针方法只能通过指针来调用。\n# 接口\n## 断言\n```\nstr, ok := value.(string)\nif ok {\n    fmt.Printf(\"\")\n} else {\n}\n```\n## 内嵌\n```\n// 接口\ntype Reader interface {\n    Read(p []byte) (n int, err error)\n}\n\ntype Writer interface {\n    Write(p []byte) (n int, err error)\n}\ntype ReaderWriter interface {\n    Reader\n    Writer\n}\n// 结构体\ntype ReaderWriter struct {\n    *Reader\n    *Writer\n}\n```\n# 并发\n## chan\n```\ncj := make(chan int)                // 无缓冲信道\ncj := make(chan int, 0)            // 无缓冲信道\ncj := make(chan *os.File, 100) // 指向文件指针的带缓冲信道\n```\n## 例子\n```\nc := make(chan int)\ngo func() {\n    list.Sort()\n    c <- 1\n}()\ndoSomethingForAWhile()\n<- c\n\n// 考虑带缓冲的任务\nfunc Serve(queue chan *Request) {\n       for req := range queue {\n            req := req\n           sem <- 1\n            go func() {\n                process(req)\n                <-sem\n            }()\n        }\n}\n```\n# panic&recover\n","slug":"Go基础语法","published":1,"updated":"2018-06-11T04:48:37.687Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cji9tizhh0001b5wxzhsgfk5a","content":"<h1 id=\"编码风格\"><a href=\"#编码风格\" class=\"headerlink\" title=\"编码风格\"></a>编码风格</h1><h2 id=\"gofmt\"><a href=\"#gofmt\" class=\"headerlink\" title=\"gofmt\"></a>gofmt</h2><p>一般会自动规范代码风格</p>\n<p> ##注释&amp;驼峰命名<br>/<em><br>    需要注释的内容\n</em>/</p>\n<h2 id=\"包名\"><a href=\"#包名\" class=\"headerlink\" title=\"包名\"></a>包名</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"bytes\"</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"变量\"><a href=\"#变量\" class=\"headerlink\" title=\"变量\"></a>变量</h1><h2 id=\"常量\"><a href=\"#常量\" class=\"headerlink\" title=\"常量\"></a>常量</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> ByteSize <span class=\"keyword\">float64</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\t_           = <span class=\"literal\">iota</span></span><br><span class=\"line\">\tKB ByteSize = <span class=\"number\">1</span> &lt;&lt; (<span class=\"number\">2</span> * <span class=\"literal\">iota</span>)</span><br><span class=\"line\">\tMB</span><br><span class=\"line\">\tGB</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\">// 主函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"Hello World!\"</span>)</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"size %f\"</span>, GB)</span><br><span class=\"line\">\t<span class=\"comment\">// size %f 64</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"声明\"><a href=\"#声明\" class=\"headerlink\" title=\"声明\"></a>声明</h2><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var (</span><br><span class=\"line\">    ErrInternal = errors.New(<span class=\"string\">\"error1\"</span>)</span><br><span class=\"line\">    ErrInternal2 = errors.New(<span class=\"string\">\"error2\"</span>)</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<h2 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><p>Go语言提供了New和make</p>\n<h3 id=\"new\"><a href=\"#new\" class=\"headerlink\" title=\"new\"></a>new</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 0值初始化</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> SyncedBuffer <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    lock sync.Mutex</span><br><span class=\"line\">    buffer bytes.Buffer</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">p := <span class=\"built_in\">new</span>(SyncedBuffer)     <span class=\"comment\">// type *SyncedBuffer</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> v SyncedBuffer            <span class=\"comment\">// type SyncedBuffer</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 如果是构造函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewFile</span><span class=\"params\">(fd <span class=\"keyword\">int</span>, name <span class=\"keyword\">string</span>)</span> *<span class=\"title\">File</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> fd &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    f := File&#123;fd, name, <span class=\"literal\">nil</span>, <span class=\"number\">0</span>&#125; <span class=\"comment\">// 如果不按顺序，就需要加名字</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &amp;f</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 复合字面可以初始化多种结构</span></span><br><span class=\"line\">a := [...]<span class=\"keyword\">string</span> &#123;Enone: <span class=\"string\">\"no error\"</span>, Eio: <span class=\"string\">\"Eio\"</span>, Einval: <span class=\"string\">\"invalid argument\"</span>&#125;</span><br><span class=\"line\">s := []<span class=\"keyword\">string</span> &#123;Enone: <span class=\"string\">\"no error\"</span>, Eio: <span class=\"string\">\"Eio\"</span>, Einval: <span class=\"string\">\"invalid argument\"</span>&#125;</span><br><span class=\"line\">m := <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">string</span> &#123;Enone: <span class=\"string\">\"no error\"</span>, Eio: <span class=\"string\">\"Eio\"</span>, Einval: <span class=\"string\">\"invalid argument\"</span>&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"make\"><a href=\"#make\" class=\"headerlink\" title=\"make\"></a>make</h3><p>`make一般用于初始化切片，映射，信道<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">10</span>, <span class=\"number\">100</span>)</span><br><span class=\"line\"><span class=\"comment\">// 一般用法, 返回的不是指针</span></span><br><span class=\"line\">v := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">100</span>)</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"分支循环\"><a href=\"#分支循环\" class=\"headerlink\" title=\"分支循环\"></a>分支循环</h1><h2 id=\"if\"><a href=\"#if\" class=\"headerlink\" title=\"if\"></a>if</h2><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> i &lt; <span class=\"built_in\">f</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">g</span>()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">err</span> := <span class=\"keyword\">file</span>.Chmod(0664); <span class=\"keyword\">err</span> != nil &#123;</span><br><span class=\"line\">    <span class=\"keyword\">log</span>.<span class=\"keyword\">Print</span>(<span class=\"keyword\">err</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">err</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"for\"><a href=\"#for\" class=\"headerlink\" title=\"for\"></a>for</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> init; condition; post &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> condition &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"comment\">// 举例</span></span><br><span class=\"line\">sum := <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++ &#123;</span><br><span class=\"line\">    sum += i</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 遍历复合结构</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> key, value := <span class=\"keyword\">range</span> oldMap &#123;</span><br><span class=\"line\">    newMap[key] = value</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 只遍历第一个</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> key := <span class=\"keyword\">range</span> oldMap &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 只遍历第二个</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> _, value := <span class=\"keyword\">range</span> array &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 遍历字符串</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> pos, char := <span class=\"keyword\">range</span> <span class=\"string\">\"日本 \\ x80 语\"</span> &#123;</span><br><span class=\"line\">    fmt.Printf()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 反转数字</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i, j := <span class=\"number\">0</span>, <span class=\"built_in\">len</span>(a) - <span class=\"number\">1</span>; i &lt; j; i,j = i+<span class=\"number\">1</span>, j<span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">    a[i], a[j] = a[j], a[i]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"switch\"><a href=\"#switch\" class=\"headerlink\" title=\"switch\"></a>switch</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">switch</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'0'</span> &lt;= c &amp;&amp; c &lt;= <span class=\"string\">'9'</span> :</span><br><span class=\"line\">    <span class=\"keyword\">return</span> c - <span class=\"string\">'0'</span></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'a'</span> &lt;= c &amp;&amp; c &lt;= <span class=\"string\">'f'</span> :</span><br><span class=\"line\">    <span class=\"keyword\">return</span> c - <span class=\"string\">'a'</span> + <span class=\"number\">10</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 处理相同条件</span></span><br><span class=\"line\"><span class=\"keyword\">switch</span> c &#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>:</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 判断类型</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> t <span class=\"keyword\">interface</span>&#123;&#125;</span><br><span class=\"line\">t = getType()</span><br><span class=\"line\"><span class=\"keyword\">switch</span> t := t.(<span class=\"keyword\">type</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">default</span> :</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"%T\"</span>, t)</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"keyword\">bool</span> :</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"boolean %t\\n\"</span>, t)</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"keyword\">int</span>:</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"integer %d\\n\"</span>, t)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"函数\"><a href=\"#函数\" class=\"headerlink\" title=\"函数\"></a>函数</h1><h2 id=\"多值返回\"><a href=\"#多值返回\" class=\"headerlink\" title=\"多值返回\"></a>多值返回</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(file *File)</span> <span class=\"title\">Write</span><span class=\"params\">(b []<span class=\"keyword\">byte</span>)</span> <span class=\"params\">(n <span class=\"keyword\">int</span>, err error)</span></span></span><br></pre></td></tr></table></figure>\n<h2 id=\"defer\"><a href=\"#defer\" class=\"headerlink\" title=\"defer\"></a>defer</h2><p>无论何种路径都能返回，如果定义多个按定义顺序相反顺序执行</p>\n<h1 id=\"切片-数组\"><a href=\"#切片-数组\" class=\"headerlink\" title=\"切片(数组)\"></a>切片(数组)</h1><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 切片是按值传递，但是底层可能是同一份数组</span></span><br><span class=\"line\"><span class=\"comment\">// 二维切片</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> Transform [<span class=\"number\">3</span>][<span class=\"number\">3</span>]<span class=\"keyword\">float64</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> LinesOfText [][]<span class=\"keyword\">byte</span></span><br><span class=\"line\">test := LinesOfTest&#123;</span><br><span class=\"line\">    []<span class=\"keyword\">byte</span>(<span class=\"string\">\"abc\"</span>),</span><br><span class=\"line\">    []<span class=\"keyword\">byte</span>(<span class=\"string\">\"abc\"</span>),</span><br><span class=\"line\">    []<span class=\"keyword\">byte</span>(<span class=\"string\">\"abc\"</span>),</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"append\"><a href=\"#append\" class=\"headerlink\" title=\"append\"></a>append</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 增加元素</span></span><br><span class=\"line\">x := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">x = <span class=\"built_in\">append</span>(x, <span class=\"number\">4</span>, <span class=\"number\">5</span>, <span class=\"number\">6</span>)</span><br><span class=\"line\">fmt.Println(x)</span><br><span class=\"line\"><span class=\"comment\">// 增加切片</span></span><br><span class=\"line\">y := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">x = <span class=\"built_in\">append</span>(x, y...)</span><br><span class=\"line\">fmt.Println(x)</span><br></pre></td></tr></table></figure>\n<h1 id=\"Map映射\"><a href=\"#Map映射\" class=\"headerlink\" title=\"Map映射\"></a>Map映射</h1><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">attend := <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">bool</span>&#123;</span><br><span class=\"line\">    <span class=\"string\">\"Ann\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Joe\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 判断是否存在</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> seconds <span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> ok <span class=\"keyword\">bool</span></span><br><span class=\"line\">seconds, ok = timeZone[tz]</span><br><span class=\"line\"><span class=\"keyword\">if</span> _, ok := timeZone[tz]; ok &#123;</span><br><span class=\"line\">    doSomething()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 删除映射</span></span><br><span class=\"line\"><span class=\"built_in\">delete</span>(timeZone, <span class=\"string\">\"PDT\"</span>)</span><br></pre></td></tr></table></figure>\n<p>初始化方式：<br>File{fd, name, nil, 0}<br>File{fd: fd, name: name}<br>make([]int, 100)</p>\n<h1 id=\"函数-1\"><a href=\"#函数-1\" class=\"headerlink\" title=\"函数\"></a>函数</h1><h2 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init\"></a>init</h2><p>在变量初始化之后，导入包初始化之后，就会初始化<br>`以指针或值为接收者的区别在于：值方法可通过指针和值调用， 而指针方法只能通过指针来调用。</p>\n<h1 id=\"接口\"><a href=\"#接口\" class=\"headerlink\" title=\"接口\"></a>接口</h1><h2 id=\"断言\"><a href=\"#断言\" class=\"headerlink\" title=\"断言\"></a>断言</h2><figure class=\"highlight xquery\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">str, ok := <span class=\"keyword\">value</span>.(string)</span><br><span class=\"line\"><span class=\"keyword\">if</span> ok &#123;</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"\"</span>)</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"内嵌\"><a href=\"#内嵌\" class=\"headerlink\" title=\"内嵌\"></a>内嵌</h2><figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 接口</span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">Reader</span> interface &#123;</span><br><span class=\"line\">    <span class=\"type\">Read</span>(p []byte) (n int, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">Writer</span> interface &#123;</span><br><span class=\"line\">    <span class=\"type\">Write</span>(p []byte) (n int, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">ReaderWriter</span> interface &#123;</span><br><span class=\"line\">    <span class=\"type\">Reader</span></span><br><span class=\"line\">    <span class=\"type\">Writer</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">// 结构体</span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">ReaderWriter</span> struct &#123;</span><br><span class=\"line\">    *<span class=\"type\">Reader</span></span><br><span class=\"line\">    *<span class=\"type\">Writer</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"并发\"><a href=\"#并发\" class=\"headerlink\" title=\"并发\"></a>并发</h1><h2 id=\"chan\"><a href=\"#chan\" class=\"headerlink\" title=\"chan\"></a>chan</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cj := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>)                <span class=\"comment\">// 无缓冲信道</span></span><br><span class=\"line\">cj := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">0</span>)            <span class=\"comment\">// 无缓冲信道</span></span><br><span class=\"line\">cj := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> *os.File, <span class=\"number\">100</span>) <span class=\"comment\">// 指向文件指针的带缓冲信道</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>)</span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    list.Sort()</span><br><span class=\"line\">    c &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">&#125;()</span><br><span class=\"line\">doSomethingForAWhile()</span><br><span class=\"line\">&lt;- c</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 考虑带缓冲的任务</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Serve</span><span class=\"params\">(queue <span class=\"keyword\">chan</span> *Request)</span></span> &#123;</span><br><span class=\"line\">       <span class=\"keyword\">for</span> req := <span class=\"keyword\">range</span> queue &#123;</span><br><span class=\"line\">            req := req</span><br><span class=\"line\">           sem &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">                process(req)</span><br><span class=\"line\">                &lt;-sem</span><br><span class=\"line\">            &#125;()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"panic-amp-recover\"><a href=\"#panic-amp-recover\" class=\"headerlink\" title=\"panic&amp;recover\"></a>panic&amp;recover</h1>","site":{"data":{}},"excerpt":"","more":"<h1 id=\"编码风格\"><a href=\"#编码风格\" class=\"headerlink\" title=\"编码风格\"></a>编码风格</h1><h2 id=\"gofmt\"><a href=\"#gofmt\" class=\"headerlink\" title=\"gofmt\"></a>gofmt</h2><p>一般会自动规范代码风格</p>\n<p> ##注释&amp;驼峰命名<br>/<em><br>    需要注释的内容\n</em>/</p>\n<h2 id=\"包名\"><a href=\"#包名\" class=\"headerlink\" title=\"包名\"></a>包名</h2><figure class=\"highlight xl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"bytes\"</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"变量\"><a href=\"#变量\" class=\"headerlink\" title=\"变量\"></a>变量</h1><h2 id=\"常量\"><a href=\"#常量\" class=\"headerlink\" title=\"常量\"></a>常量</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> ByteSize <span class=\"keyword\">float64</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\t_           = <span class=\"literal\">iota</span></span><br><span class=\"line\">\tKB ByteSize = <span class=\"number\">1</span> &lt;&lt; (<span class=\"number\">2</span> * <span class=\"literal\">iota</span>)</span><br><span class=\"line\">\tMB</span><br><span class=\"line\">\tGB</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\">// 主函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"Hello World!\"</span>)</span><br><span class=\"line\">\tfmt.Println(<span class=\"string\">\"size %f\"</span>, GB)</span><br><span class=\"line\">\t<span class=\"comment\">// size %f 64</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"声明\"><a href=\"#声明\" class=\"headerlink\" title=\"声明\"></a>声明</h2><figure class=\"highlight lisp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var (</span><br><span class=\"line\">    ErrInternal = errors.New(<span class=\"string\">\"error1\"</span>)</span><br><span class=\"line\">    ErrInternal2 = errors.New(<span class=\"string\">\"error2\"</span>)</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<h2 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h2><p>Go语言提供了New和make</p>\n<h3 id=\"new\"><a href=\"#new\" class=\"headerlink\" title=\"new\"></a>new</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 0值初始化</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> SyncedBuffer <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    lock sync.Mutex</span><br><span class=\"line\">    buffer bytes.Buffer</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">p := <span class=\"built_in\">new</span>(SyncedBuffer)     <span class=\"comment\">// type *SyncedBuffer</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> v SyncedBuffer            <span class=\"comment\">// type SyncedBuffer</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 如果是构造函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewFile</span><span class=\"params\">(fd <span class=\"keyword\">int</span>, name <span class=\"keyword\">string</span>)</span> *<span class=\"title\">File</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> fd &lt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    f := File&#123;fd, name, <span class=\"literal\">nil</span>, <span class=\"number\">0</span>&#125; <span class=\"comment\">// 如果不按顺序，就需要加名字</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &amp;f</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 复合字面可以初始化多种结构</span></span><br><span class=\"line\">a := [...]<span class=\"keyword\">string</span> &#123;Enone: <span class=\"string\">\"no error\"</span>, Eio: <span class=\"string\">\"Eio\"</span>, Einval: <span class=\"string\">\"invalid argument\"</span>&#125;</span><br><span class=\"line\">s := []<span class=\"keyword\">string</span> &#123;Enone: <span class=\"string\">\"no error\"</span>, Eio: <span class=\"string\">\"Eio\"</span>, Einval: <span class=\"string\">\"invalid argument\"</span>&#125;</span><br><span class=\"line\">m := <span class=\"keyword\">map</span>[<span class=\"keyword\">int</span>]<span class=\"keyword\">string</span> &#123;Enone: <span class=\"string\">\"no error\"</span>, Eio: <span class=\"string\">\"Eio\"</span>, Einval: <span class=\"string\">\"invalid argument\"</span>&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"make\"><a href=\"#make\" class=\"headerlink\" title=\"make\"></a>make</h3><p>`make一般用于初始化切片，映射，信道<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">10</span>, <span class=\"number\">100</span>)</span><br><span class=\"line\"><span class=\"comment\">// 一般用法, 返回的不是指针</span></span><br><span class=\"line\">v := <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">100</span>)</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"分支循环\"><a href=\"#分支循环\" class=\"headerlink\" title=\"分支循环\"></a>分支循环</h1><h2 id=\"if\"><a href=\"#if\" class=\"headerlink\" title=\"if\"></a>if</h2><figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> i &lt; <span class=\"built_in\">f</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">g</span>()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">err</span> := <span class=\"keyword\">file</span>.Chmod(0664); <span class=\"keyword\">err</span> != nil &#123;</span><br><span class=\"line\">    <span class=\"keyword\">log</span>.<span class=\"keyword\">Print</span>(<span class=\"keyword\">err</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">err</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"for\"><a href=\"#for\" class=\"headerlink\" title=\"for\"></a>for</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> init; condition; post &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> condition &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"comment\">// 举例</span></span><br><span class=\"line\">sum := <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++ &#123;</span><br><span class=\"line\">    sum += i</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 遍历复合结构</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> key, value := <span class=\"keyword\">range</span> oldMap &#123;</span><br><span class=\"line\">    newMap[key] = value</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 只遍历第一个</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> key := <span class=\"keyword\">range</span> oldMap &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 只遍历第二个</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> _, value := <span class=\"keyword\">range</span> array &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 遍历字符串</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> pos, char := <span class=\"keyword\">range</span> <span class=\"string\">\"日本 \\ x80 语\"</span> &#123;</span><br><span class=\"line\">    fmt.Printf()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 反转数字</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i, j := <span class=\"number\">0</span>, <span class=\"built_in\">len</span>(a) - <span class=\"number\">1</span>; i &lt; j; i,j = i+<span class=\"number\">1</span>, j<span class=\"number\">-1</span> &#123;</span><br><span class=\"line\">    a[i], a[j] = a[j], a[i]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"switch\"><a href=\"#switch\" class=\"headerlink\" title=\"switch\"></a>switch</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">switch</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'0'</span> &lt;= c &amp;&amp; c &lt;= <span class=\"string\">'9'</span> :</span><br><span class=\"line\">    <span class=\"keyword\">return</span> c - <span class=\"string\">'0'</span></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'a'</span> &lt;= c &amp;&amp; c &lt;= <span class=\"string\">'f'</span> :</span><br><span class=\"line\">    <span class=\"keyword\">return</span> c - <span class=\"string\">'a'</span> + <span class=\"number\">10</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 处理相同条件</span></span><br><span class=\"line\"><span class=\"keyword\">switch</span> c &#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>:</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 判断类型</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> t <span class=\"keyword\">interface</span>&#123;&#125;</span><br><span class=\"line\">t = getType()</span><br><span class=\"line\"><span class=\"keyword\">switch</span> t := t.(<span class=\"keyword\">type</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">default</span> :</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"%T\"</span>, t)</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"keyword\">bool</span> :</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"boolean %t\\n\"</span>, t)</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"keyword\">int</span>:</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"integer %d\\n\"</span>, t)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"函数\"><a href=\"#函数\" class=\"headerlink\" title=\"函数\"></a>函数</h1><h2 id=\"多值返回\"><a href=\"#多值返回\" class=\"headerlink\" title=\"多值返回\"></a>多值返回</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(file *File)</span> <span class=\"title\">Write</span><span class=\"params\">(b []<span class=\"keyword\">byte</span>)</span> <span class=\"params\">(n <span class=\"keyword\">int</span>, err error)</span></span></span><br></pre></td></tr></table></figure>\n<h2 id=\"defer\"><a href=\"#defer\" class=\"headerlink\" title=\"defer\"></a>defer</h2><p>无论何种路径都能返回，如果定义多个按定义顺序相反顺序执行</p>\n<h1 id=\"切片-数组\"><a href=\"#切片-数组\" class=\"headerlink\" title=\"切片(数组)\"></a>切片(数组)</h1><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 切片是按值传递，但是底层可能是同一份数组</span></span><br><span class=\"line\"><span class=\"comment\">// 二维切片</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> Transform [<span class=\"number\">3</span>][<span class=\"number\">3</span>]<span class=\"keyword\">float64</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> LinesOfText [][]<span class=\"keyword\">byte</span></span><br><span class=\"line\">test := LinesOfTest&#123;</span><br><span class=\"line\">    []<span class=\"keyword\">byte</span>(<span class=\"string\">\"abc\"</span>),</span><br><span class=\"line\">    []<span class=\"keyword\">byte</span>(<span class=\"string\">\"abc\"</span>),</span><br><span class=\"line\">    []<span class=\"keyword\">byte</span>(<span class=\"string\">\"abc\"</span>),</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"append\"><a href=\"#append\" class=\"headerlink\" title=\"append\"></a>append</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 增加元素</span></span><br><span class=\"line\">x := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">x = <span class=\"built_in\">append</span>(x, <span class=\"number\">4</span>, <span class=\"number\">5</span>, <span class=\"number\">6</span>)</span><br><span class=\"line\">fmt.Println(x)</span><br><span class=\"line\"><span class=\"comment\">// 增加切片</span></span><br><span class=\"line\">y := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;</span><br><span class=\"line\">x = <span class=\"built_in\">append</span>(x, y...)</span><br><span class=\"line\">fmt.Println(x)</span><br></pre></td></tr></table></figure>\n<h1 id=\"Map映射\"><a href=\"#Map映射\" class=\"headerlink\" title=\"Map映射\"></a>Map映射</h1><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">attend := <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">bool</span>&#123;</span><br><span class=\"line\">    <span class=\"string\">\"Ann\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Joe\"</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 判断是否存在</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> seconds <span class=\"keyword\">int</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> ok <span class=\"keyword\">bool</span></span><br><span class=\"line\">seconds, ok = timeZone[tz]</span><br><span class=\"line\"><span class=\"keyword\">if</span> _, ok := timeZone[tz]; ok &#123;</span><br><span class=\"line\">    doSomething()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 删除映射</span></span><br><span class=\"line\"><span class=\"built_in\">delete</span>(timeZone, <span class=\"string\">\"PDT\"</span>)</span><br></pre></td></tr></table></figure>\n<p>初始化方式：<br>File{fd, name, nil, 0}<br>File{fd: fd, name: name}<br>make([]int, 100)</p>\n<h1 id=\"函数-1\"><a href=\"#函数-1\" class=\"headerlink\" title=\"函数\"></a>函数</h1><h2 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init\"></a>init</h2><p>在变量初始化之后，导入包初始化之后，就会初始化<br>`以指针或值为接收者的区别在于：值方法可通过指针和值调用， 而指针方法只能通过指针来调用。</p>\n<h1 id=\"接口\"><a href=\"#接口\" class=\"headerlink\" title=\"接口\"></a>接口</h1><h2 id=\"断言\"><a href=\"#断言\" class=\"headerlink\" title=\"断言\"></a>断言</h2><figure class=\"highlight xquery\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">str, ok := <span class=\"keyword\">value</span>.(string)</span><br><span class=\"line\"><span class=\"keyword\">if</span> ok &#123;</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"\"</span>)</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"内嵌\"><a href=\"#内嵌\" class=\"headerlink\" title=\"内嵌\"></a>内嵌</h2><figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 接口</span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">Reader</span> interface &#123;</span><br><span class=\"line\">    <span class=\"type\">Read</span>(p []byte) (n int, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">Writer</span> interface &#123;</span><br><span class=\"line\">    <span class=\"type\">Write</span>(p []byte) (n int, err error)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">ReaderWriter</span> interface &#123;</span><br><span class=\"line\">    <span class=\"type\">Reader</span></span><br><span class=\"line\">    <span class=\"type\">Writer</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">// 结构体</span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">ReaderWriter</span> struct &#123;</span><br><span class=\"line\">    *<span class=\"type\">Reader</span></span><br><span class=\"line\">    *<span class=\"type\">Writer</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"并发\"><a href=\"#并发\" class=\"headerlink\" title=\"并发\"></a>并发</h1><h2 id=\"chan\"><a href=\"#chan\" class=\"headerlink\" title=\"chan\"></a>chan</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cj := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>)                <span class=\"comment\">// 无缓冲信道</span></span><br><span class=\"line\">cj := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">0</span>)            <span class=\"comment\">// 无缓冲信道</span></span><br><span class=\"line\">cj := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> *os.File, <span class=\"number\">100</span>) <span class=\"comment\">// 指向文件指针的带缓冲信道</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"例子\"><a href=\"#例子\" class=\"headerlink\" title=\"例子\"></a>例子</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>)</span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    list.Sort()</span><br><span class=\"line\">    c &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">&#125;()</span><br><span class=\"line\">doSomethingForAWhile()</span><br><span class=\"line\">&lt;- c</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 考虑带缓冲的任务</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Serve</span><span class=\"params\">(queue <span class=\"keyword\">chan</span> *Request)</span></span> &#123;</span><br><span class=\"line\">       <span class=\"keyword\">for</span> req := <span class=\"keyword\">range</span> queue &#123;</span><br><span class=\"line\">            req := req</span><br><span class=\"line\">           sem &lt;- <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">                process(req)</span><br><span class=\"line\">                &lt;-sem</span><br><span class=\"line\">            &#125;()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"panic-amp-recover\"><a href=\"#panic-amp-recover\" class=\"headerlink\" title=\"panic&amp;recover\"></a>panic&amp;recover</h1>"},{"title":"Redis实战","date":"2018-06-11T04:55:17.000Z","_content":"# 应用场景\n* 当做缓存，缓存未命中再访问MySQL，这样能降低读的延迟\n* 原子计数\n* 最新TopN数据\n使用list中的LTRIM latest.comments 0 5000 这样永远只保存最近的5000个ID\n* 带权值的排序\n使用sorted set， 然后ZADD命令\n* 过期时间\n* 优先级的队列系统\n\n# 数据类型\n* List\n* Set\n* Sorted set\n* Hash\n* 自增原子\n# 特点\n* 主从同步\n* 持久化\n# strings\n```\nstruct sdshdr {\n    long len;\n    long free;\n    char buf[];\n}\n```\n* set\n```\nset name \"hello\"\n```\n* setnx\n其中nx是不存在的意思, 如果存在则设置失败\n```\nsetnx name \"hello\"\n```\n* setex\n如果超过10秒，get就会为空\n```\nsetex name 10 \"red\"\n```\n* setrange\n替换字符串\n* mset \n设置多组值\n* msetnx\n会回滚\n* getset\n返回旧值\n* mget\n获取多组数据，如果不存在返回nil\n* incr/decr\n自增，如果不存在默认为1,而且用get的时候得到的会是字符串\n# hashes\n* hset\n```\nhset myhash filed1 hello\n```\n* hsetnx\n如果key不存在则创建，如果key存在则返回0（不会覆盖）\n* hmset\n设置多个filed\n* hget\n```\nhget myhash field1\n```\n* hmget\n* hincrby\n```\n// 给指定的filed加定值\nhincrby myhash field3 -8\n```\n* hexists\n```\n//判断filed是否存在\nhexists myhash filed1\n```\n \n* hlen \n返回filed的数量\n* hdel\n删除指定filed，并返回1 成功\n* hkeys hvals hgetall\n# lists\n链表结构，主要只有push和pop, 是一个双向链表，长度为2的32次方，既可以当做栈也可以当做队列\n也有阻塞版本的pop\n* lpush rpush\n```\n// l和r是表示左右的意思\nlpush mylist \"world\"\nlrange mylist 0 -1\n```\n* linsert\n```\n// 在world前面加上there\nlinsert mylist3 before \"world\" \"there\"\n```\n* lset\n```\n设置指定下标的值\nlset mylist 0 \"four\"\n```\n* lrem\n```\n// 从 key 对应 list 中删除 count 个和 value 相同的元素\n// count > 0 删除count， count < 0 从尾部开始删除, count == 0删除所有\nlrem mylist 2 \"hello\"\n```\n* ltrim\n```\n// 只保留from到to的数据\nltrim mylist8 1 -1 // 相当于删除了第一个元素\n```\n* lpop\n删除头部元素并返回头部元素\n* rpoplpush\n原子操作，从第一个链表取出来放到第二个链表头，并返回这个值\n* lindex \n```\nlindex mylist index  // 返回第index的位置\n```\n# sets\nset 是集合， hashtable实现， sorted_set是跳表\n* sadd\n* smemebers\n获取所有元素\n* srem\n删除\n* spop\n随机返回\n* sdiff\n去除 a里面和b相关，把剩下的返回\n比如  1 2 3 diff 3 4 5 =  1 2\n* sdiffstore\n```\n// 与sdiff的区别就是会存起来\nsdiffstore myset1 myset2 tomyset3\n```\n \n* sinter sinterstore\n交集\n* sunion sunionstore\n并集\n* smove\n```\nsmove mysetfrom mysetto three\n// 把three从from移动到to\n```\n\n* scard\n返回元素个数\n* sismember\n返回是否是元素\n* srandmember \n随机返回，不删除\n# sorted sets\n排序的， 跳表+hashtable\n```\nzadd myzset 1 \"one\"\nzadd myzset 2 \"two\"\nzadd myzset 3 \"three\"\nzrange myzset 0 -1 withscores // zrevrange是从大到小的顺序\n// \"one\" \"1\" \"two\" \"2\" \"three\" \"3\"\n```\n\n* zincrby\n```\nzincrby myset 2 \"one\" // 增加分数\n```\n\n* zrank zrevrank\n从小到大返回 下标, 从大到小返回 下标\n* zrangebyscore\n* zcount \n返回分数score区间的个数\n* zcard\n返回集合个数\n* zscore \n返回元素的score\n* zremrangebyrank\n删除排名区间的， 下标顺序\n* zremrangebyscore \n删除score区间的元素\n\n* keys *\n列出所有key, 可以用字符串匹配 keys abc* 之类\n* exists\n判断key是否存在\n* del \n删除key\n* expire \n设置有效时间, 通过ttl获取有效时长\n* move \n转移数据库\n```\nselect 0\nset age 30\nmove age 1\nselect 1\nget age\n```\n\n* persist\n移除过期时间\n* randomkey\n* rename\n* type\n获取key对应的value类型\n* ping  info  quit ..\n","source":"_posts/Redis实战.md","raw":"---\ntitle: Redis实战\ndate: 2018-06-11 12:55:17\ncategories: Redis\ntags: [Redis, 技术栈]\n---\n# 应用场景\n* 当做缓存，缓存未命中再访问MySQL，这样能降低读的延迟\n* 原子计数\n* 最新TopN数据\n使用list中的LTRIM latest.comments 0 5000 这样永远只保存最近的5000个ID\n* 带权值的排序\n使用sorted set， 然后ZADD命令\n* 过期时间\n* 优先级的队列系统\n\n# 数据类型\n* List\n* Set\n* Sorted set\n* Hash\n* 自增原子\n# 特点\n* 主从同步\n* 持久化\n# strings\n```\nstruct sdshdr {\n    long len;\n    long free;\n    char buf[];\n}\n```\n* set\n```\nset name \"hello\"\n```\n* setnx\n其中nx是不存在的意思, 如果存在则设置失败\n```\nsetnx name \"hello\"\n```\n* setex\n如果超过10秒，get就会为空\n```\nsetex name 10 \"red\"\n```\n* setrange\n替换字符串\n* mset \n设置多组值\n* msetnx\n会回滚\n* getset\n返回旧值\n* mget\n获取多组数据，如果不存在返回nil\n* incr/decr\n自增，如果不存在默认为1,而且用get的时候得到的会是字符串\n# hashes\n* hset\n```\nhset myhash filed1 hello\n```\n* hsetnx\n如果key不存在则创建，如果key存在则返回0（不会覆盖）\n* hmset\n设置多个filed\n* hget\n```\nhget myhash field1\n```\n* hmget\n* hincrby\n```\n// 给指定的filed加定值\nhincrby myhash field3 -8\n```\n* hexists\n```\n//判断filed是否存在\nhexists myhash filed1\n```\n \n* hlen \n返回filed的数量\n* hdel\n删除指定filed，并返回1 成功\n* hkeys hvals hgetall\n# lists\n链表结构，主要只有push和pop, 是一个双向链表，长度为2的32次方，既可以当做栈也可以当做队列\n也有阻塞版本的pop\n* lpush rpush\n```\n// l和r是表示左右的意思\nlpush mylist \"world\"\nlrange mylist 0 -1\n```\n* linsert\n```\n// 在world前面加上there\nlinsert mylist3 before \"world\" \"there\"\n```\n* lset\n```\n设置指定下标的值\nlset mylist 0 \"four\"\n```\n* lrem\n```\n// 从 key 对应 list 中删除 count 个和 value 相同的元素\n// count > 0 删除count， count < 0 从尾部开始删除, count == 0删除所有\nlrem mylist 2 \"hello\"\n```\n* ltrim\n```\n// 只保留from到to的数据\nltrim mylist8 1 -1 // 相当于删除了第一个元素\n```\n* lpop\n删除头部元素并返回头部元素\n* rpoplpush\n原子操作，从第一个链表取出来放到第二个链表头，并返回这个值\n* lindex \n```\nlindex mylist index  // 返回第index的位置\n```\n# sets\nset 是集合， hashtable实现， sorted_set是跳表\n* sadd\n* smemebers\n获取所有元素\n* srem\n删除\n* spop\n随机返回\n* sdiff\n去除 a里面和b相关，把剩下的返回\n比如  1 2 3 diff 3 4 5 =  1 2\n* sdiffstore\n```\n// 与sdiff的区别就是会存起来\nsdiffstore myset1 myset2 tomyset3\n```\n \n* sinter sinterstore\n交集\n* sunion sunionstore\n并集\n* smove\n```\nsmove mysetfrom mysetto three\n// 把three从from移动到to\n```\n\n* scard\n返回元素个数\n* sismember\n返回是否是元素\n* srandmember \n随机返回，不删除\n# sorted sets\n排序的， 跳表+hashtable\n```\nzadd myzset 1 \"one\"\nzadd myzset 2 \"two\"\nzadd myzset 3 \"three\"\nzrange myzset 0 -1 withscores // zrevrange是从大到小的顺序\n// \"one\" \"1\" \"two\" \"2\" \"three\" \"3\"\n```\n\n* zincrby\n```\nzincrby myset 2 \"one\" // 增加分数\n```\n\n* zrank zrevrank\n从小到大返回 下标, 从大到小返回 下标\n* zrangebyscore\n* zcount \n返回分数score区间的个数\n* zcard\n返回集合个数\n* zscore \n返回元素的score\n* zremrangebyrank\n删除排名区间的， 下标顺序\n* zremrangebyscore \n删除score区间的元素\n\n* keys *\n列出所有key, 可以用字符串匹配 keys abc* 之类\n* exists\n判断key是否存在\n* del \n删除key\n* expire \n设置有效时间, 通过ttl获取有效时长\n* move \n转移数据库\n```\nselect 0\nset age 30\nmove age 1\nselect 1\nget age\n```\n\n* persist\n移除过期时间\n* randomkey\n* rename\n* type\n获取key对应的value类型\n* ping  info  quit ..\n","slug":"Redis实战","published":1,"updated":"2018-06-11T07:11:58.425Z","_id":"cji9tizhl0003b5wxpmqrrv04","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h1><ul>\n<li>当做缓存，缓存未命中再访问MySQL，这样能降低读的延迟</li>\n<li>原子计数</li>\n<li>最新TopN数据<br>使用list中的LTRIM latest.comments 0 5000 这样永远只保存最近的5000个ID</li>\n<li>带权值的排序<br>使用sorted set， 然后ZADD命令</li>\n<li>过期时间</li>\n<li>优先级的队列系统</li>\n</ul>\n<h1 id=\"数据类型\"><a href=\"#数据类型\" class=\"headerlink\" title=\"数据类型\"></a>数据类型</h1><ul>\n<li>List</li>\n<li>Set</li>\n<li>Sorted set</li>\n<li>Hash</li>\n<li>自增原子<h1 id=\"特点\"><a href=\"#特点\" class=\"headerlink\" title=\"特点\"></a>特点</h1></li>\n<li>主从同步</li>\n<li><p>持久化</p>\n<h1 id=\"strings\"><a href=\"#strings\" class=\"headerlink\" title=\"strings\"></a>strings</h1><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sdshdr</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> len;</span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"built_in\">free</span>;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>set</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"built_in\">name</span> <span class=\"string\">\"hello\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>setnx<br>其中nx是不存在的意思, 如果存在则设置失败</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setnx <span class=\"built_in\">name</span> <span class=\"string\">\"hello\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>setex<br>如果超过10秒，get就会为空</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setex <span class=\"built_in\">name</span> <span class=\"number\">10</span> <span class=\"string\">\"red\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>setrange<br>替换字符串</p>\n</li>\n<li>mset<br>设置多组值</li>\n<li>msetnx<br>会回滚</li>\n<li>getset<br>返回旧值</li>\n<li>mget<br>获取多组数据，如果不存在返回nil</li>\n<li>incr/decr<br>自增，如果不存在默认为1,而且用get的时候得到的会是字符串<h1 id=\"hashes\"><a href=\"#hashes\" class=\"headerlink\" title=\"hashes\"></a>hashes</h1></li>\n<li><p>hset</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">hset</span> myhash filed1 hello</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hsetnx<br>如果key不存在则创建，如果key存在则返回0（不会覆盖）</p>\n</li>\n<li>hmset<br>设置多个filed</li>\n<li><p>hget</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">hget</span> myhash field1</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hmget</p>\n</li>\n<li><p>hincrby</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 给指定的filed加定值</span></span><br><span class=\"line\">hincrby myhash field3 <span class=\"number\">-8</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hexists</p>\n<figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//判断filed是否存在</span></span><br><span class=\"line\">hexists myhash filed1</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>hlen<br>返回filed的数量</li>\n<li>hdel<br>删除指定filed，并返回1 成功</li>\n<li>hkeys hvals hgetall<h1 id=\"lists\"><a href=\"#lists\" class=\"headerlink\" title=\"lists\"></a>lists</h1>链表结构，主要只有push和pop, 是一个双向链表，长度为2的32次方，既可以当做栈也可以当做队列<br>也有阻塞版本的pop</li>\n<li><p>lpush rpush</p>\n<figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// l和r是表示左右的意思</span><br><span class=\"line\">lpush mylist <span class=\"string\">\"world\"</span></span><br><span class=\"line\"><span class=\"keyword\">lrange</span> mylist <span class=\"number\">0</span> <span class=\"number\">-1</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>linsert</p>\n<figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 在world前面加上there</span><br><span class=\"line\"><span class=\"keyword\">linsert</span> mylist3 before <span class=\"string\">\"world\"</span> <span class=\"string\">\"there\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>lset</p>\n<figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">设置指定下标的值</span><br><span class=\"line\"><span class=\"keyword\">lset</span> mylist <span class=\"number\">0</span> <span class=\"string\">\"four\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>lrem</p>\n<figure class=\"highlight excel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 从 key 对应 list 中删除 <span class=\"built_in\">count</span> 个和 <span class=\"built_in\">value</span> 相同的元素</span><br><span class=\"line\">// <span class=\"built_in\">count</span> &gt; <span class=\"number\">0</span> 删除<span class=\"built_in\">count</span>， <span class=\"built_in\">count</span> &lt; <span class=\"number\">0</span> 从尾部开始删除, <span class=\"built_in\">count</span> == <span class=\"number\">0</span>删除所有</span><br><span class=\"line\">lrem mylist <span class=\"number\">2</span> <span class=\"string\">\"hello\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ltrim</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 只保留from到to的数据</span></span><br><span class=\"line\">ltrim mylist8 <span class=\"number\">1</span> <span class=\"number\">-1</span> <span class=\"comment\">// 相当于删除了第一个元素</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>lpop<br>删除头部元素并返回头部元素</p>\n</li>\n<li>rpoplpush<br>原子操作，从第一个链表取出来放到第二个链表头，并返回这个值</li>\n<li>lindex <figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">lindex</span> mylist index  // 返回第index的位置</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h1 id=\"sets\"><a href=\"#sets\" class=\"headerlink\" title=\"sets\"></a>sets</h1><p>set 是集合， hashtable实现， sorted_set是跳表</p>\n<ul>\n<li>sadd</li>\n<li>smemebers<br>获取所有元素</li>\n<li>srem<br>删除</li>\n<li>spop<br>随机返回</li>\n<li>sdiff<br>去除 a里面和b相关，把剩下的返回<br>比如  1 2 3 diff 3 4 5 =  1 2</li>\n<li>sdiffstore<figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 与sdiff的区别就是会存起来</span></span><br><span class=\"line\">sdiffstore myset1 myset2 tomyset3</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>sinter sinterstore<br>交集</li>\n<li>sunion sunionstore<br>并集</li>\n<li><p>smove</p>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">smove mysetfrom mysetto <span class=\"literal\">three</span></span><br><span class=\"line\">// 把<span class=\"literal\">three</span>从<span class=\"built_in\">from</span>移动到<span class=\"built_in\">to</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>scard<br>返回元素个数</p>\n</li>\n<li>sismember<br>返回是否是元素</li>\n<li><p>srandmember<br>随机返回，不删除</p>\n<h1 id=\"sorted-sets\"><a href=\"#sorted-sets\" class=\"headerlink\" title=\"sorted sets\"></a>sorted sets</h1><p>排序的， 跳表+hashtable</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zadd myzset <span class=\"number\">1</span> <span class=\"string\">\"one\"</span></span><br><span class=\"line\">zadd myzset <span class=\"number\">2</span> <span class=\"string\">\"two\"</span></span><br><span class=\"line\">zadd myzset <span class=\"number\">3</span> <span class=\"string\">\"three\"</span></span><br><span class=\"line\">zrange myzset <span class=\"number\">0</span> -<span class=\"number\">1</span> withscores <span class=\"regexp\">//</span> zrevrange是从大到小的顺序</span><br><span class=\"line\"><span class=\"regexp\">//</span> <span class=\"string\">\"one\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"two\"</span> <span class=\"string\">\"2\"</span> <span class=\"string\">\"three\"</span> <span class=\"string\">\"3\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>zincrby</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zincrby myset <span class=\"number\">2</span> <span class=\"string\">\"one\"</span> <span class=\"comment\">// 增加分数</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>zrank zrevrank<br>从小到大返回 下标, 从大到小返回 下标</p>\n</li>\n<li>zrangebyscore</li>\n<li>zcount<br>返回分数score区间的个数</li>\n<li>zcard<br>返回集合个数</li>\n<li>zscore<br>返回元素的score</li>\n<li>zremrangebyrank<br>删除排名区间的， 下标顺序</li>\n<li><p>zremrangebyscore<br>删除score区间的元素</p>\n</li>\n<li><p>keys <em><br>列出所有key, 可以用字符串匹配 keys abc</em> 之类</p>\n</li>\n<li>exists<br>判断key是否存在</li>\n<li>del<br>删除key</li>\n<li>expire<br>设置有效时间, 通过ttl获取有效时长</li>\n<li><p>move<br>转移数据库</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> age <span class=\"comment\">30</span></span><br><span class=\"line\">move <span class=\"comment\">age 1</span></span><br><span class=\"line\">select <span class=\"comment\">1</span></span><br><span class=\"line\">get <span class=\"comment\">age</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>persist<br>移除过期时间</p>\n</li>\n<li>randomkey</li>\n<li>rename</li>\n<li>type<br>获取key对应的value类型</li>\n<li>ping  info  quit ..</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h1><ul>\n<li>当做缓存，缓存未命中再访问MySQL，这样能降低读的延迟</li>\n<li>原子计数</li>\n<li>最新TopN数据<br>使用list中的LTRIM latest.comments 0 5000 这样永远只保存最近的5000个ID</li>\n<li>带权值的排序<br>使用sorted set， 然后ZADD命令</li>\n<li>过期时间</li>\n<li>优先级的队列系统</li>\n</ul>\n<h1 id=\"数据类型\"><a href=\"#数据类型\" class=\"headerlink\" title=\"数据类型\"></a>数据类型</h1><ul>\n<li>List</li>\n<li>Set</li>\n<li>Sorted set</li>\n<li>Hash</li>\n<li>自增原子<h1 id=\"特点\"><a href=\"#特点\" class=\"headerlink\" title=\"特点\"></a>特点</h1></li>\n<li>主从同步</li>\n<li><p>持久化</p>\n<h1 id=\"strings\"><a href=\"#strings\" class=\"headerlink\" title=\"strings\"></a>strings</h1><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sdshdr</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> len;</span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"built_in\">free</span>;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>set</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"built_in\">name</span> <span class=\"string\">\"hello\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>setnx<br>其中nx是不存在的意思, 如果存在则设置失败</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setnx <span class=\"built_in\">name</span> <span class=\"string\">\"hello\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>setex<br>如果超过10秒，get就会为空</p>\n<figure class=\"highlight applescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setex <span class=\"built_in\">name</span> <span class=\"number\">10</span> <span class=\"string\">\"red\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>setrange<br>替换字符串</p>\n</li>\n<li>mset<br>设置多组值</li>\n<li>msetnx<br>会回滚</li>\n<li>getset<br>返回旧值</li>\n<li>mget<br>获取多组数据，如果不存在返回nil</li>\n<li>incr/decr<br>自增，如果不存在默认为1,而且用get的时候得到的会是字符串<h1 id=\"hashes\"><a href=\"#hashes\" class=\"headerlink\" title=\"hashes\"></a>hashes</h1></li>\n<li><p>hset</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">hset</span> myhash filed1 hello</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hsetnx<br>如果key不存在则创建，如果key存在则返回0（不会覆盖）</p>\n</li>\n<li>hmset<br>设置多个filed</li>\n<li><p>hget</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">hget</span> myhash field1</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hmget</p>\n</li>\n<li><p>hincrby</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 给指定的filed加定值</span></span><br><span class=\"line\">hincrby myhash field3 <span class=\"number\">-8</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>hexists</p>\n<figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//判断filed是否存在</span></span><br><span class=\"line\">hexists myhash filed1</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>hlen<br>返回filed的数量</li>\n<li>hdel<br>删除指定filed，并返回1 成功</li>\n<li>hkeys hvals hgetall<h1 id=\"lists\"><a href=\"#lists\" class=\"headerlink\" title=\"lists\"></a>lists</h1>链表结构，主要只有push和pop, 是一个双向链表，长度为2的32次方，既可以当做栈也可以当做队列<br>也有阻塞版本的pop</li>\n<li><p>lpush rpush</p>\n<figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// l和r是表示左右的意思</span><br><span class=\"line\">lpush mylist <span class=\"string\">\"world\"</span></span><br><span class=\"line\"><span class=\"keyword\">lrange</span> mylist <span class=\"number\">0</span> <span class=\"number\">-1</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>linsert</p>\n<figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 在world前面加上there</span><br><span class=\"line\"><span class=\"keyword\">linsert</span> mylist3 before <span class=\"string\">\"world\"</span> <span class=\"string\">\"there\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>lset</p>\n<figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">设置指定下标的值</span><br><span class=\"line\"><span class=\"keyword\">lset</span> mylist <span class=\"number\">0</span> <span class=\"string\">\"four\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>lrem</p>\n<figure class=\"highlight excel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 从 key 对应 list 中删除 <span class=\"built_in\">count</span> 个和 <span class=\"built_in\">value</span> 相同的元素</span><br><span class=\"line\">// <span class=\"built_in\">count</span> &gt; <span class=\"number\">0</span> 删除<span class=\"built_in\">count</span>， <span class=\"built_in\">count</span> &lt; <span class=\"number\">0</span> 从尾部开始删除, <span class=\"built_in\">count</span> == <span class=\"number\">0</span>删除所有</span><br><span class=\"line\">lrem mylist <span class=\"number\">2</span> <span class=\"string\">\"hello\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ltrim</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 只保留from到to的数据</span></span><br><span class=\"line\">ltrim mylist8 <span class=\"number\">1</span> <span class=\"number\">-1</span> <span class=\"comment\">// 相当于删除了第一个元素</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>lpop<br>删除头部元素并返回头部元素</p>\n</li>\n<li>rpoplpush<br>原子操作，从第一个链表取出来放到第二个链表头，并返回这个值</li>\n<li>lindex <figure class=\"highlight tcl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">lindex</span> mylist index  // 返回第index的位置</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h1 id=\"sets\"><a href=\"#sets\" class=\"headerlink\" title=\"sets\"></a>sets</h1><p>set 是集合， hashtable实现， sorted_set是跳表</p>\n<ul>\n<li>sadd</li>\n<li>smemebers<br>获取所有元素</li>\n<li>srem<br>删除</li>\n<li>spop<br>随机返回</li>\n<li>sdiff<br>去除 a里面和b相关，把剩下的返回<br>比如  1 2 3 diff 3 4 5 =  1 2</li>\n<li>sdiffstore<figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 与sdiff的区别就是会存起来</span></span><br><span class=\"line\">sdiffstore myset1 myset2 tomyset3</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ul>\n<li>sinter sinterstore<br>交集</li>\n<li>sunion sunionstore<br>并集</li>\n<li><p>smove</p>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">smove mysetfrom mysetto <span class=\"literal\">three</span></span><br><span class=\"line\">// 把<span class=\"literal\">three</span>从<span class=\"built_in\">from</span>移动到<span class=\"built_in\">to</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>scard<br>返回元素个数</p>\n</li>\n<li>sismember<br>返回是否是元素</li>\n<li><p>srandmember<br>随机返回，不删除</p>\n<h1 id=\"sorted-sets\"><a href=\"#sorted-sets\" class=\"headerlink\" title=\"sorted sets\"></a>sorted sets</h1><p>排序的， 跳表+hashtable</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zadd myzset <span class=\"number\">1</span> <span class=\"string\">\"one\"</span></span><br><span class=\"line\">zadd myzset <span class=\"number\">2</span> <span class=\"string\">\"two\"</span></span><br><span class=\"line\">zadd myzset <span class=\"number\">3</span> <span class=\"string\">\"three\"</span></span><br><span class=\"line\">zrange myzset <span class=\"number\">0</span> -<span class=\"number\">1</span> withscores <span class=\"regexp\">//</span> zrevrange是从大到小的顺序</span><br><span class=\"line\"><span class=\"regexp\">//</span> <span class=\"string\">\"one\"</span> <span class=\"string\">\"1\"</span> <span class=\"string\">\"two\"</span> <span class=\"string\">\"2\"</span> <span class=\"string\">\"three\"</span> <span class=\"string\">\"3\"</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>zincrby</p>\n<figure class=\"highlight lsl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zincrby myset <span class=\"number\">2</span> <span class=\"string\">\"one\"</span> <span class=\"comment\">// 增加分数</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>zrank zrevrank<br>从小到大返回 下标, 从大到小返回 下标</p>\n</li>\n<li>zrangebyscore</li>\n<li>zcount<br>返回分数score区间的个数</li>\n<li>zcard<br>返回集合个数</li>\n<li>zscore<br>返回元素的score</li>\n<li>zremrangebyrank<br>删除排名区间的， 下标顺序</li>\n<li><p>zremrangebyscore<br>删除score区间的元素</p>\n</li>\n<li><p>keys <em><br>列出所有key, 可以用字符串匹配 keys abc</em> 之类</p>\n</li>\n<li>exists<br>判断key是否存在</li>\n<li>del<br>删除key</li>\n<li>expire<br>设置有效时间, 通过ttl获取有效时长</li>\n<li><p>move<br>转移数据库</p>\n<figure class=\"highlight gams\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> age <span class=\"comment\">30</span></span><br><span class=\"line\">move <span class=\"comment\">age 1</span></span><br><span class=\"line\">select <span class=\"comment\">1</span></span><br><span class=\"line\">get <span class=\"comment\">age</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>persist<br>移除过期时间</p>\n</li>\n<li>randomkey</li>\n<li>rename</li>\n<li>type<br>获取key对应的value类型</li>\n<li>ping  info  quit ..</li>\n</ul>\n"},{"title":"Go高级编程.md","date":"2018-06-09T03:11:17.000Z","_content":"\nhttps://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-04-memory.html\n# 数组\n## 数组定义方式\n```\nvar a [3]int                    // 定义一个长度为3的int类型数组, 元素全部为0\n\nvar b = [...]int{1, 2, 3}       // 定义一个长度为3的int类型数组, 元素为 1, 2, 3\n\nvar c = [...]int{2: 3, 1: 2}    // 定义一个长度为3的int类型数组, 元素为 0, 2, 3\n\nvar d = [...]int{1, 2, 4: 5, 6} // 定义一个长度为6的int类型数组, 元素为 1, 2, 0, 0, 5, 6\n\n```\n## 数组指针\n```\nvar a = [...]int{1, 2, 3} // a 是一个数组\n\nvar b = &a                // b 是指向数组的指针\n\n\nfmt.Println(a[0], a[1])   // 打印数组的前2个元素\n\nfmt.Println(b[0], b[1])   // 通过数组指针访问数组元素的方式和数组类似\n\n\nfor i, v := range b {     // 通过数组指针迭代数组的元素\n\n    fmt.Println(i, v)\n\n}\n```\n## 数组遍历\n```\n    for i := range a {\n\n        fmt.Printf(\"b[%d]: %d\\n\", i, b[i])\n\n    }\n\n    for i, v := range b {\n\n        fmt.Printf(\"b[%d]: %d\\n\", i, v)\n\n    }\n\n    for i := 0; i < len(c); i++ {\n\n        fmt.Printf(\"b[%d]: %d\\n\", i, b[i])\n\n    }\n\n```\n## 函数数组、管道数组\n```\n// 图像解码器数组\n\nvar decoder1 [2]func(io.Reader) (image.Image, error)\n\nvar decoder2 = [...]func(io.Reader) (image.Image, error){\n\n    png.Decode,\n\n    jpeg.Decode,\n\n}\n\n\n// 接口数组\n\nvar unknown1 [2]interface{}\n\nvar unknown2 = [...]interface{}{123, \"你好\"}\n\n\n// 管道数组\n\nvar chanList = [2]chan int{}\n\n```\n## 空数组\n长度为0的数组在内存中并不占用空间。空数组虽然很少直接使用，但是可以用于强调某种特有类型的操作时避免分配额外的内存空间，比如用于管道的同步操作：\n```\n    c1 := make(chan [0]int)\n\n    go func() {\n\n        fmt.Println(\"c1\")\n\n        c1 <- [0]int{}\n\n    }()\n\n    <-c1\n\n```\n在这里，我们并不关心管道中传输数据的真实类型，其中管道接收和发送操作只是用于消息的同步。对于这种场景，我们用空数组来作为管道类型可以减少管道元素赋值时的开销。当然一般更倾向于用无类型的匿名结构体代替：\n```\n    c2 := make(chan struct{})\n\n    go func() {\n\n        fmt.Println(\"c2\")\n\n        c2 <- struct{}{} // struct{}部分是类型, {}表示对应的结构体值\n\n    }()\n\n    <-c2\n```\n# 字符串\n## 类似切片\n字符串虽然不是切片，但是支持切片操作，不同位置的切片底层也访问的同一块内存数据（因为字符串是只读的，相同的字符串面值常量通常是对应同一个字符串常量）：\n```\ns := \"hello, world\"\n\nhello := s[:5]\n\nworld := s[7:]\n\n\ns1 := \"hello, world\"[:5]\n\ns2 := \"hello, world\"[7:]\n\n```\n和数组一样，内置的len和cap函数返回相同的结果，都对应字符串的长度。也可以通过reflect.StringHeader结构访问字符串的长度（这里只是为了演示字符串的结构，并不是推荐的做法）：\n```\nfmt.Println(\"len(s):\", (*reflect.StringHeader)(unsafe.Pointer(&s)).Len)   // 12\n\nfmt.Println(\"len(s1):\", (*reflect.StringHeader)(unsafe.Pointer(&s1)).Len) // 5\n\nfmt.Println(\"len(s2):\", (*reflect.StringHeader)(unsafe.Pointer(&s2)).Len) // 5\n```\n# 切片(slice)\n```\nvar (\n\n    a []int               // nil切片, 和 nil 相等, 一般用来表示一个不存在的切片\n\n    b = []int{}           // 空切片, 和 nil 不相等, 一般用来表示一个空的集合\n\n    c = []int{1, 2, 3}    // 有3个元素的切片, len和cap都为3\n\n    d = c[:2]             // 有2个元素的切片, len为2, cap为3\n\n    e = c[0:2:cap(c)]     // 有2个元素的切片, len为2, cap为3\n\n    f = c[:0]             // 有0个元素的切片, len为0, cap为3\n\n    g = make([]int, 3)    // 有3个元素的切片, len和cap都为3\n\n    h = make([]int, 2, 3) // 有2个元素的切片, len为2, cap为3\n\n    i = make([]int, 0, 3) // 有0个元素的切片, len为0, cap为3\n\n)\n``\n## 添加切片\n```\nvar a []int\n\na = append(a, 1)               // 追加1个元素\n\na = append(a, 1, 2, 3)         // 追加多个元素, 手写解包方式\n\na = append(a, []int{1,2,3}...) // 追加一个切片, 切片需要解包\n\n\n```\n`在容量不足的情况下，append的操作会导致重新分配内存，从而导致巨大的内存分配和复制数据代价`\n```\nvar a = []int{1,2,3}\n\na = append([]int{0}, a...)        // 在开头添加1个元素\n\na = append([]int{-3,-2,-1}, a...) // 在开头添加1个切片\n```\n```\nvar a []int\n\na = append(a[:i], append([]int{x}, a[i:]...)...)     // 在第i个位置插入x\n\na = append(a[:i], append([]int{1,2,3}, a[i:]...)...) // 在第i个位置插入切片\na = append(a, x...)       // 为x切片扩展足够的空间\n\ncopy(a[i+len(x):], a[i:]) // a[i:]向后移动len(x)个位置\n\ncopy(a[i:], x)            // 复制新添加的切片\n```\n## 删除切片\n需要重新赋值切片防止内存泄漏\n```\nfunc FindPhoneNumber(filename string) []byte {\n\n    b, _ := ioutil.ReadFile(filename)\n\n    b = regexp.MustCompile(\"[0-9]+\").Find(b)\n\n    return append([]byte{}, b...) // 这里\n\n}\n\n```\n删除切片有时候会影响GC\n```\nvar a []*int{ ... }\n\na = a[:len(a)-1]    // 本删除的最后一个元素依然被引用, 可能导致GC操作被阻碍\n\nvar a []*int{ ... }\na[len(a)-1] = nil // GC回收最后一个元素内存\n\na = a[:len(a)-1]  // 从切片删除最后一个元素\n\n```\n可以用copy和append组合可以避免创建中间的临时切片，同样是完成添加元素的操作：\n```\na = append(a, 0)     // 切片扩展1个空间\n\ncopy(a[i+1:], a[i:]) // a[i:]向后移动1个位置\n\ns[i] = x             // 设置新添加的元素\n\n```\n第一句append用于扩展切片的长度，为要插入的元素留出空间。第二句copy操作将要插入位置开始之后的元素向后挪动一个位置。第三句真实地将新添加的元素赋值到对应的位置。操作语句虽然冗长了一点，但是相比前面的方法，可以减少中间创建的临时切片。\n用copy和append组合也可以实现在中间位置插入多个元素(也就是插入一个切片):\n```\na = append(a, x...)       // 为x切片扩展足够的空间\n\ncopy(a[i+len(x):], a[i:]) // a[i:]向后移动len(x)个位置\n\ncopy(a[i:], x)            // 复制新添加的切片\n```\n也可以用copy完成删除开头的元素：\n```\na = []int{1, 2, 3}\n\na = a[:copy(a, a[1:])] // 删除开头1个元素\n\na = a[:copy(a, a[N:])] // 删除开头N个元素\n\n```\n对于删除中间的元素，需要对剩余的元素进行一次整体挪动，同样可以用append或copy原地完成：\n```\na = []int{1, 2, 3, ...}\n\n\na = append(a[:i], a[i+1:]...) // 删除中间1个元素\n\na = append(a[:i], a[i+N:]...) // 删除中间N个元素\n\n\na = a[:copy(a[i:], a[i+1:])]  // 删除中间1个元素\n\na = a[:copy(a[i:], a[i+N:])]  // 删除中间N个元素\n```\n# 并发模型\n## 加锁\n```\nvar total struct {\n\n    sync.Mutex\n\n    value int\n\n}\n通过sync.lock()和sync.Done()\n```\n## 原子\n```\nimport (\n\n    \"sync\"\n\n    \"sync/atomic\"\n\n)\n//用法：\nfunc worker(wg *sync.WaitGroup) {\n\n    defer wg.Done()\n\n\n    var i uint64\n\n    for i = 0; i <= 100; i++ {\n\n        atomic.AddUint64(&total, i)\n\n    }\n\n}\n\n\nfunc main() {\n\n    var wg sync.WaitGroup\n\n    wg.Add(2)\n\n\n    go worker(&wg)\n\n    go worker(&wg)\n\n    wg.Wait()\n\n}\n```\n## 单例\n```\n我们可以将通用的代码提取出来，就成了标准库中sync.Once的实现：\ntype Once struct {\n\n    m    Mutex\n\n    done uint32\n\n}\n\n\nfunc (o *Once) Do(f func()) {\n\n    if atomic.LoadUint32(&o.done) == 1 {\n\n        return\n\n    }\n\n\n    o.m.Lock()\n\n    defer o.m.Unlock()\n\n\n    if o.done == 0 {\n\n        defer atomic.StoreUint32(&o.done, 1)\n\n        f()\n\n    }\n\n}\n\n基于sync.Once重新实现单件模式：\nvar (\n\n    instance *singleton\n\n    once     sync.Once\n\n)\n\n\nfunc Instance() *singleton {\n\n    once.Do(func() {\n\n        instance = &singleton{}\n\n    })\n\n    return instance\n\n}\n```\n## 带缓冲chan\n测试了下才知道原来\n<-chan int  像这样的只能接收值\nchan<- int  像这样的只能发送值\n```\nvar limit = make(chan int, 3)\n\n\nfunc main() {\n\n    for _, w := range work {\n\n        go func() {\n\n            limit <- 1\n\n            w()\n\n            <-limit\n\n        }()\n\n    }\n\n    select{}\n\n}\nfunc main() {\n\n    done := make(chan int, 10) // 带 10 个缓存\n\n\n    // 开N个后台打印线程\n\n    for i := 0; i < cap(done); i++ {\n\n        go func(){\n\n            fmt.Println(\"你好, 世界\")\n\n            done <- 1\n\n        }()\n\n    }\n\n\n    // 等待N个后台线程完成\n\n    for i := 0; i < cap(done); i++ {\n\n        <-done\n\n    }\n\n}\n//其实也可以用\nsync.WaitGroup\n```\n## select\n```\n基于select实现的管道的超时判断：\n    select {\n\n    case v := <-in:\n\n        fmt.Println(v)\n\n    case <-time.After(time.Second):\n\n        return // 超时\n\n    }\n\n通过select的default分支实现非阻塞的管道发送或接收操作：\n    select {\n\n    case v := <-in:\n\n        fmt.Println(v)\n\n    default:\n\n        // 没有数据\n\n    }\n\n通过select来阻止main函数退出：\nfunc main() {\n\n    // do some thins\n\n    select{}\n\n}\n```\n但是管道的发送操作和接收操作是一一对应的，如果要停止多个Goroutine那么可能需要创建同样数量的管道，这个代价太大了。其实我们可以通过close关闭一个管道来实现广播的效果，所有从关闭管道接收的操作均会收到一个零值和一个可选的失败标志。\n```\nfunc worker(cannel chan bool) {\n\n    for {\n\n        select {\n\n        default:\n\n            fmt.Println(\"hello\")\n\n            // 正常工作\n\n        case <-cannel:\n\n            // 退出\n\n        }\n\n    }\n\n}\n\n\nfunc main() {\n\n    cancel := make(chan bool)\n\n\n    for i := 0; i < 10; i++ {\n\n        go worker(cancel)\n\n    }\n\n\n    time.Sleep(time.Second)\n\n    close(cancel)\n\n}\n```\n# 异常\n异常必须放在defer func () {}()\n","source":"_posts/Go高级编程.md","raw":"---\ntitle: Go高级编程.md\ndate: 2018-06-09 11:11:17\ncategories: Go语言\ntags: [Go]\n---\n\nhttps://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-04-memory.html\n# 数组\n## 数组定义方式\n```\nvar a [3]int                    // 定义一个长度为3的int类型数组, 元素全部为0\n\nvar b = [...]int{1, 2, 3}       // 定义一个长度为3的int类型数组, 元素为 1, 2, 3\n\nvar c = [...]int{2: 3, 1: 2}    // 定义一个长度为3的int类型数组, 元素为 0, 2, 3\n\nvar d = [...]int{1, 2, 4: 5, 6} // 定义一个长度为6的int类型数组, 元素为 1, 2, 0, 0, 5, 6\n\n```\n## 数组指针\n```\nvar a = [...]int{1, 2, 3} // a 是一个数组\n\nvar b = &a                // b 是指向数组的指针\n\n\nfmt.Println(a[0], a[1])   // 打印数组的前2个元素\n\nfmt.Println(b[0], b[1])   // 通过数组指针访问数组元素的方式和数组类似\n\n\nfor i, v := range b {     // 通过数组指针迭代数组的元素\n\n    fmt.Println(i, v)\n\n}\n```\n## 数组遍历\n```\n    for i := range a {\n\n        fmt.Printf(\"b[%d]: %d\\n\", i, b[i])\n\n    }\n\n    for i, v := range b {\n\n        fmt.Printf(\"b[%d]: %d\\n\", i, v)\n\n    }\n\n    for i := 0; i < len(c); i++ {\n\n        fmt.Printf(\"b[%d]: %d\\n\", i, b[i])\n\n    }\n\n```\n## 函数数组、管道数组\n```\n// 图像解码器数组\n\nvar decoder1 [2]func(io.Reader) (image.Image, error)\n\nvar decoder2 = [...]func(io.Reader) (image.Image, error){\n\n    png.Decode,\n\n    jpeg.Decode,\n\n}\n\n\n// 接口数组\n\nvar unknown1 [2]interface{}\n\nvar unknown2 = [...]interface{}{123, \"你好\"}\n\n\n// 管道数组\n\nvar chanList = [2]chan int{}\n\n```\n## 空数组\n长度为0的数组在内存中并不占用空间。空数组虽然很少直接使用，但是可以用于强调某种特有类型的操作时避免分配额外的内存空间，比如用于管道的同步操作：\n```\n    c1 := make(chan [0]int)\n\n    go func() {\n\n        fmt.Println(\"c1\")\n\n        c1 <- [0]int{}\n\n    }()\n\n    <-c1\n\n```\n在这里，我们并不关心管道中传输数据的真实类型，其中管道接收和发送操作只是用于消息的同步。对于这种场景，我们用空数组来作为管道类型可以减少管道元素赋值时的开销。当然一般更倾向于用无类型的匿名结构体代替：\n```\n    c2 := make(chan struct{})\n\n    go func() {\n\n        fmt.Println(\"c2\")\n\n        c2 <- struct{}{} // struct{}部分是类型, {}表示对应的结构体值\n\n    }()\n\n    <-c2\n```\n# 字符串\n## 类似切片\n字符串虽然不是切片，但是支持切片操作，不同位置的切片底层也访问的同一块内存数据（因为字符串是只读的，相同的字符串面值常量通常是对应同一个字符串常量）：\n```\ns := \"hello, world\"\n\nhello := s[:5]\n\nworld := s[7:]\n\n\ns1 := \"hello, world\"[:5]\n\ns2 := \"hello, world\"[7:]\n\n```\n和数组一样，内置的len和cap函数返回相同的结果，都对应字符串的长度。也可以通过reflect.StringHeader结构访问字符串的长度（这里只是为了演示字符串的结构，并不是推荐的做法）：\n```\nfmt.Println(\"len(s):\", (*reflect.StringHeader)(unsafe.Pointer(&s)).Len)   // 12\n\nfmt.Println(\"len(s1):\", (*reflect.StringHeader)(unsafe.Pointer(&s1)).Len) // 5\n\nfmt.Println(\"len(s2):\", (*reflect.StringHeader)(unsafe.Pointer(&s2)).Len) // 5\n```\n# 切片(slice)\n```\nvar (\n\n    a []int               // nil切片, 和 nil 相等, 一般用来表示一个不存在的切片\n\n    b = []int{}           // 空切片, 和 nil 不相等, 一般用来表示一个空的集合\n\n    c = []int{1, 2, 3}    // 有3个元素的切片, len和cap都为3\n\n    d = c[:2]             // 有2个元素的切片, len为2, cap为3\n\n    e = c[0:2:cap(c)]     // 有2个元素的切片, len为2, cap为3\n\n    f = c[:0]             // 有0个元素的切片, len为0, cap为3\n\n    g = make([]int, 3)    // 有3个元素的切片, len和cap都为3\n\n    h = make([]int, 2, 3) // 有2个元素的切片, len为2, cap为3\n\n    i = make([]int, 0, 3) // 有0个元素的切片, len为0, cap为3\n\n)\n``\n## 添加切片\n```\nvar a []int\n\na = append(a, 1)               // 追加1个元素\n\na = append(a, 1, 2, 3)         // 追加多个元素, 手写解包方式\n\na = append(a, []int{1,2,3}...) // 追加一个切片, 切片需要解包\n\n\n```\n`在容量不足的情况下，append的操作会导致重新分配内存，从而导致巨大的内存分配和复制数据代价`\n```\nvar a = []int{1,2,3}\n\na = append([]int{0}, a...)        // 在开头添加1个元素\n\na = append([]int{-3,-2,-1}, a...) // 在开头添加1个切片\n```\n```\nvar a []int\n\na = append(a[:i], append([]int{x}, a[i:]...)...)     // 在第i个位置插入x\n\na = append(a[:i], append([]int{1,2,3}, a[i:]...)...) // 在第i个位置插入切片\na = append(a, x...)       // 为x切片扩展足够的空间\n\ncopy(a[i+len(x):], a[i:]) // a[i:]向后移动len(x)个位置\n\ncopy(a[i:], x)            // 复制新添加的切片\n```\n## 删除切片\n需要重新赋值切片防止内存泄漏\n```\nfunc FindPhoneNumber(filename string) []byte {\n\n    b, _ := ioutil.ReadFile(filename)\n\n    b = regexp.MustCompile(\"[0-9]+\").Find(b)\n\n    return append([]byte{}, b...) // 这里\n\n}\n\n```\n删除切片有时候会影响GC\n```\nvar a []*int{ ... }\n\na = a[:len(a)-1]    // 本删除的最后一个元素依然被引用, 可能导致GC操作被阻碍\n\nvar a []*int{ ... }\na[len(a)-1] = nil // GC回收最后一个元素内存\n\na = a[:len(a)-1]  // 从切片删除最后一个元素\n\n```\n可以用copy和append组合可以避免创建中间的临时切片，同样是完成添加元素的操作：\n```\na = append(a, 0)     // 切片扩展1个空间\n\ncopy(a[i+1:], a[i:]) // a[i:]向后移动1个位置\n\ns[i] = x             // 设置新添加的元素\n\n```\n第一句append用于扩展切片的长度，为要插入的元素留出空间。第二句copy操作将要插入位置开始之后的元素向后挪动一个位置。第三句真实地将新添加的元素赋值到对应的位置。操作语句虽然冗长了一点，但是相比前面的方法，可以减少中间创建的临时切片。\n用copy和append组合也可以实现在中间位置插入多个元素(也就是插入一个切片):\n```\na = append(a, x...)       // 为x切片扩展足够的空间\n\ncopy(a[i+len(x):], a[i:]) // a[i:]向后移动len(x)个位置\n\ncopy(a[i:], x)            // 复制新添加的切片\n```\n也可以用copy完成删除开头的元素：\n```\na = []int{1, 2, 3}\n\na = a[:copy(a, a[1:])] // 删除开头1个元素\n\na = a[:copy(a, a[N:])] // 删除开头N个元素\n\n```\n对于删除中间的元素，需要对剩余的元素进行一次整体挪动，同样可以用append或copy原地完成：\n```\na = []int{1, 2, 3, ...}\n\n\na = append(a[:i], a[i+1:]...) // 删除中间1个元素\n\na = append(a[:i], a[i+N:]...) // 删除中间N个元素\n\n\na = a[:copy(a[i:], a[i+1:])]  // 删除中间1个元素\n\na = a[:copy(a[i:], a[i+N:])]  // 删除中间N个元素\n```\n# 并发模型\n## 加锁\n```\nvar total struct {\n\n    sync.Mutex\n\n    value int\n\n}\n通过sync.lock()和sync.Done()\n```\n## 原子\n```\nimport (\n\n    \"sync\"\n\n    \"sync/atomic\"\n\n)\n//用法：\nfunc worker(wg *sync.WaitGroup) {\n\n    defer wg.Done()\n\n\n    var i uint64\n\n    for i = 0; i <= 100; i++ {\n\n        atomic.AddUint64(&total, i)\n\n    }\n\n}\n\n\nfunc main() {\n\n    var wg sync.WaitGroup\n\n    wg.Add(2)\n\n\n    go worker(&wg)\n\n    go worker(&wg)\n\n    wg.Wait()\n\n}\n```\n## 单例\n```\n我们可以将通用的代码提取出来，就成了标准库中sync.Once的实现：\ntype Once struct {\n\n    m    Mutex\n\n    done uint32\n\n}\n\n\nfunc (o *Once) Do(f func()) {\n\n    if atomic.LoadUint32(&o.done) == 1 {\n\n        return\n\n    }\n\n\n    o.m.Lock()\n\n    defer o.m.Unlock()\n\n\n    if o.done == 0 {\n\n        defer atomic.StoreUint32(&o.done, 1)\n\n        f()\n\n    }\n\n}\n\n基于sync.Once重新实现单件模式：\nvar (\n\n    instance *singleton\n\n    once     sync.Once\n\n)\n\n\nfunc Instance() *singleton {\n\n    once.Do(func() {\n\n        instance = &singleton{}\n\n    })\n\n    return instance\n\n}\n```\n## 带缓冲chan\n测试了下才知道原来\n<-chan int  像这样的只能接收值\nchan<- int  像这样的只能发送值\n```\nvar limit = make(chan int, 3)\n\n\nfunc main() {\n\n    for _, w := range work {\n\n        go func() {\n\n            limit <- 1\n\n            w()\n\n            <-limit\n\n        }()\n\n    }\n\n    select{}\n\n}\nfunc main() {\n\n    done := make(chan int, 10) // 带 10 个缓存\n\n\n    // 开N个后台打印线程\n\n    for i := 0; i < cap(done); i++ {\n\n        go func(){\n\n            fmt.Println(\"你好, 世界\")\n\n            done <- 1\n\n        }()\n\n    }\n\n\n    // 等待N个后台线程完成\n\n    for i := 0; i < cap(done); i++ {\n\n        <-done\n\n    }\n\n}\n//其实也可以用\nsync.WaitGroup\n```\n## select\n```\n基于select实现的管道的超时判断：\n    select {\n\n    case v := <-in:\n\n        fmt.Println(v)\n\n    case <-time.After(time.Second):\n\n        return // 超时\n\n    }\n\n通过select的default分支实现非阻塞的管道发送或接收操作：\n    select {\n\n    case v := <-in:\n\n        fmt.Println(v)\n\n    default:\n\n        // 没有数据\n\n    }\n\n通过select来阻止main函数退出：\nfunc main() {\n\n    // do some thins\n\n    select{}\n\n}\n```\n但是管道的发送操作和接收操作是一一对应的，如果要停止多个Goroutine那么可能需要创建同样数量的管道，这个代价太大了。其实我们可以通过close关闭一个管道来实现广播的效果，所有从关闭管道接收的操作均会收到一个零值和一个可选的失败标志。\n```\nfunc worker(cannel chan bool) {\n\n    for {\n\n        select {\n\n        default:\n\n            fmt.Println(\"hello\")\n\n            // 正常工作\n\n        case <-cannel:\n\n            // 退出\n\n        }\n\n    }\n\n}\n\n\nfunc main() {\n\n    cancel := make(chan bool)\n\n\n    for i := 0; i < 10; i++ {\n\n        go worker(cancel)\n\n    }\n\n\n    time.Sleep(time.Second)\n\n    close(cancel)\n\n}\n```\n# 异常\n异常必须放在defer func () {}()\n","slug":"Go高级编程","published":1,"updated":"2018-06-11T04:48:37.687Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cji9tizi3000db5wxud4b4o1t","content":"<p><a href=\"https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-04-memory.html\" target=\"_blank\" rel=\"noopener\">https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-04-memory.html</a></p>\n<h1 id=\"数组\"><a href=\"#数组\" class=\"headerlink\" title=\"数组\"></a>数组</h1><h2 id=\"数组定义方式\"><a href=\"#数组定义方式\" class=\"headerlink\" title=\"数组定义方式\"></a>数组定义方式</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> [<span class=\"number\">3</span>]int                    <span class=\"comment\">// 定义一个长度为3的int类型数组, 元素全部为0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">b</span> = [...]int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;       <span class=\"comment\">// 定义一个长度为3的int类型数组, 元素为 1, 2, 3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> c = [...]int&#123;<span class=\"number\">2</span>: <span class=\"number\">3</span>, <span class=\"number\">1</span>: <span class=\"number\">2</span>&#125;    <span class=\"comment\">// 定义一个长度为3的int类型数组, 元素为 0, 2, 3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> d = [...]int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">4</span>: <span class=\"number\">5</span>, <span class=\"number\">6</span>&#125; <span class=\"comment\">// 定义一个长度为6的int类型数组, 元素为 1, 2, 0, 0, 5, 6</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"数组指针\"><a href=\"#数组指针\" class=\"headerlink\" title=\"数组指针\"></a>数组指针</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> = [...]int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125; <span class=\"comment\">// a 是一个数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">b</span> = &amp;<span class=\"selector-tag\">a</span>                <span class=\"comment\">// b 是指向数组的指针</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"selector-tag\">a</span>[<span class=\"number\">0</span>], <span class=\"selector-tag\">a</span>[<span class=\"number\">1</span>])   <span class=\"comment\">// 打印数组的前2个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"selector-tag\">b</span>[<span class=\"number\">0</span>], <span class=\"selector-tag\">b</span>[<span class=\"number\">1</span>])   <span class=\"comment\">// 通过数组指针访问数组元素的方式和数组类似</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> <span class=\"selector-tag\">i</span>, v := range <span class=\"selector-tag\">b</span> &#123;     <span class=\"comment\">// 通过数组指针迭代数组的元素</span></span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Println(<span class=\"selector-tag\">i</span>, v)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"数组遍历\"><a href=\"#数组遍历\" class=\"headerlink\" title=\"数组遍历\"></a>数组遍历</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"keyword\">range</span> a &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"b[%d]: %d\\n\"</span>, i, b[i])</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> b &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"b[%d]: %d\\n\"</span>, i, v)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(c); i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"b[%d]: %d\\n\"</span>, i, b[i])</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"函数数组、管道数组\"><a href=\"#函数数组、管道数组\" class=\"headerlink\" title=\"函数数组、管道数组\"></a>函数数组、管道数组</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 图像解码器数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> decoder1 [<span class=\"number\">2</span>]func(io.Reader) (image<span class=\"selector-class\">.Image</span>, error)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> decoder2 = [...]func(io.Reader) (image<span class=\"selector-class\">.Image</span>, error)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    png<span class=\"selector-class\">.Decode</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">    jpeg<span class=\"selector-class\">.Decode</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 接口数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> unknown1 [<span class=\"number\">2</span>]interface&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> unknown2 = [...]interface&#123;&#125;&#123;<span class=\"number\">123</span>, <span class=\"string\">\"你好\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 管道数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> chanList = [<span class=\"number\">2</span>]chan int&#123;&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"空数组\"><a href=\"#空数组\" class=\"headerlink\" title=\"空数组\"></a>空数组</h2><p>长度为0的数组在内存中并不占用空间。空数组虽然很少直接使用，但是可以用于强调某种特有类型的操作时避免分配额外的内存空间，比如用于管道的同步操作：<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c1 := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> [<span class=\"number\">0</span>]<span class=\"keyword\">int</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"c1\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    c1 &lt;- [<span class=\"number\">0</span>]<span class=\"keyword\">int</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;-c1</span><br></pre></td></tr></table></figure></p>\n<p>在这里，我们并不关心管道中传输数据的真实类型，其中管道接收和发送操作只是用于消息的同步。对于这种场景，我们用空数组来作为管道类型可以减少管道元素赋值时的开销。当然一般更倾向于用无类型的匿名结构体代替：<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c2 := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span>&#123;&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"c2\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    c2 &lt;- <span class=\"keyword\">struct</span>&#123;&#125;&#123;&#125; <span class=\"comment\">// struct&#123;&#125;部分是类型, &#123;&#125;表示对应的结构体值</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;-c2</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"字符串\"><a href=\"#字符串\" class=\"headerlink\" title=\"字符串\"></a>字符串</h1><h2 id=\"类似切片\"><a href=\"#类似切片\" class=\"headerlink\" title=\"类似切片\"></a>类似切片</h2><p>字符串虽然不是切片，但是支持切片操作，不同位置的切片底层也访问的同一块内存数据（因为字符串是只读的，相同的字符串面值常量通常是对应同一个字符串常量）：<br><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s := <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">hello := s[:5]</span><br><span class=\"line\"></span><br><span class=\"line\">world := s[7:]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">s1 := <span class=\"string\">\"hello, world\"</span>[:5]</span><br><span class=\"line\"></span><br><span class=\"line\">s2 := <span class=\"string\">\"hello, world\"</span>[7:]</span><br></pre></td></tr></table></figure></p>\n<p>和数组一样，内置的len和cap函数返回相同的结果，都对应字符串的长度。也可以通过reflect.StringHeader结构访问字符串的长度（这里只是为了演示字符串的结构，并不是推荐的做法）：<br><figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fmt.Println(<span class=\"string\">\"len(s):\"</span>, (*reflect.StringHeader)(unsafe.Pointer(<span class=\"meta\">&amp;s)).Len)   <span class=\"comment\">// 12</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"len(s1):\"</span>, (*reflect.StringHeader)(unsafe.Pointer(<span class=\"meta\">&amp;s1)).Len) <span class=\"comment\">// 5</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"len(s2):\"</span>, (*reflect.StringHeader)(unsafe.Pointer(<span class=\"meta\">&amp;s2)).Len) <span class=\"comment\">// 5</span></span></span><br></pre></td></tr></table></figure></p>\n<h1 id=\"切片-slice\"><a href=\"#切片-slice\" class=\"headerlink\" title=\"切片(slice)\"></a>切片(slice)</h1><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> (</span><br><span class=\"line\"></span><br><span class=\"line\">    a []<span class=\"keyword\">int</span>               <span class=\"comment\">// nil切片, 和 nil 相等, 一般用来表示一个不存在的切片</span></span><br><span class=\"line\"></span><br><span class=\"line\">    b = []<span class=\"keyword\">int</span>&#123;&#125;           <span class=\"comment\">// 空切片, 和 nil 不相等, 一般用来表示一个空的集合</span></span><br><span class=\"line\"></span><br><span class=\"line\">    c = []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;    <span class=\"comment\">// 有3个元素的切片, len和cap都为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    d = c[:<span class=\"number\">2</span>]             <span class=\"comment\">// 有2个元素的切片, len为2, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    e = c[<span class=\"number\">0</span>:<span class=\"number\">2</span>:<span class=\"built_in\">cap</span>(c)]     <span class=\"comment\">// 有2个元素的切片, len为2, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    f = c[:<span class=\"number\">0</span>]             <span class=\"comment\">// 有0个元素的切片, len为0, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    g = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">3</span>)    <span class=\"comment\">// 有3个元素的切片, len和cap都为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    h = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>) <span class=\"comment\">// 有2个元素的切片, len为2, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    i = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">0</span>, <span class=\"number\">3</span>) <span class=\"comment\">// 有0个元素的切片, len为0, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"string\">``</span></span><br><span class=\"line\">## 添加切片</span><br></pre></td></tr></table></figure>\n<p>var a []int</p>\n<p>a = append(a, 1)               // 追加1个元素</p>\n<p>a = append(a, 1, 2, 3)         // 追加多个元素, 手写解包方式</p>\n<p>a = append(a, []int{1,2,3}…) // 追加一个切片, 切片需要解包</p>\n<figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`在容量不足的情况下，append的操作会导致重新分配内存，从而导致巨大的内存分配和复制数据代价`</span><br></pre></td></tr></table></figure>\n<p>var a = []int{1,2,3}</p>\n<p>a = append([]int{0}, a…)        // 在开头添加1个元素</p>\n<p>a = append([]int{-3,-2,-1}, a…) // 在开头添加1个切片<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">```</span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> []int</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], append([]int&#123;x&#125;, <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]...)...)     <span class=\"comment\">// 在第i个位置插入x</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], append([]int&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;, <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]...)...) <span class=\"comment\">// 在第i个位置插入切片</span></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>, x...)       <span class=\"comment\">// 为x切片扩展足够的空间</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i+len(x)</span></span>:], <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]) <span class=\"comment\">// a[i:]向后移动len(x)个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i:], x)</span></span>            <span class=\"comment\">// 复制新添加的切片</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"删除切片\"><a href=\"#删除切片\" class=\"headerlink\" title=\"删除切片\"></a>删除切片</h2><p>需要重新赋值切片防止内存泄漏<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">FindPhoneNumber</span><span class=\"params\">(filename <span class=\"keyword\">string</span>)</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    b, _ := ioutil.ReadFile(filename)</span><br><span class=\"line\"></span><br><span class=\"line\">    b = regexp.MustCompile(<span class=\"string\">\"[0-9]+\"</span>).Find(b)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">append</span>([]<span class=\"keyword\">byte</span>&#123;&#125;, b...) <span class=\"comment\">// 这里</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>删除切片有时候会影响GC<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> []*int&#123; ... &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:len(a)-<span class=\"number\">1</span>]    <span class=\"comment\">// 本删除的最后一个元素依然被引用, 可能导致GC操作被阻碍</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> []*int&#123; ... &#125;</span><br><span class=\"line\"><span class=\"selector-tag\">a</span>[len(a)-<span class=\"number\">1</span>] = nil <span class=\"comment\">// GC回收最后一个元素内存</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:len(a)-<span class=\"number\">1</span>]  <span class=\"comment\">// 从切片删除最后一个元素</span></span><br></pre></td></tr></table></figure></p>\n<p>可以用copy和append组合可以避免创建中间的临时切片，同样是完成添加元素的操作：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>, <span class=\"number\">0</span>)     <span class=\"comment\">// 切片扩展1个空间</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i+<span class=\"number\">1</span>:], a[i:])</span></span> <span class=\"comment\">// a[i:]向后移动1个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">s[i] = x             <span class=\"comment\">// 设置新添加的元素</span></span><br></pre></td></tr></table></figure></p>\n<p>第一句append用于扩展切片的长度，为要插入的元素留出空间。第二句copy操作将要插入位置开始之后的元素向后挪动一个位置。第三句真实地将新添加的元素赋值到对应的位置。操作语句虽然冗长了一点，但是相比前面的方法，可以减少中间创建的临时切片。<br>用copy和append组合也可以实现在中间位置插入多个元素(也就是插入一个切片):<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>, x...)       <span class=\"comment\">// 为x切片扩展足够的空间</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i+len(x)</span></span>:], <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]) <span class=\"comment\">// a[i:]向后移动len(x)个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i:], x)</span></span>            <span class=\"comment\">// 复制新添加的切片</span></span><br></pre></td></tr></table></figure></p>\n<p>也可以用copy完成删除开头的元素：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = []int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>, <span class=\"selector-tag\">a</span>[<span class=\"number\">1</span>:])] <span class=\"comment\">// 删除开头1个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>, <span class=\"selector-tag\">a</span>[N:])] <span class=\"comment\">// 删除开头N个元素</span></span><br></pre></td></tr></table></figure></p>\n<p>对于删除中间的元素，需要对剩余的元素进行一次整体挪动，同样可以用append或copy原地完成：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = []int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, ...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], <span class=\"selector-tag\">a</span>[i+<span class=\"number\">1</span>:]...) <span class=\"comment\">// 删除中间1个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], <span class=\"selector-tag\">a</span>[i+N:]...) <span class=\"comment\">// 删除中间N个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:], <span class=\"selector-tag\">a</span>[i+<span class=\"number\">1</span>:])]  <span class=\"comment\">// 删除中间1个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:], <span class=\"selector-tag\">a</span>[i+N:])]  <span class=\"comment\">// 删除中间N个元素</span></span><br></pre></td></tr></table></figure></p>\n<h1 id=\"并发模型\"><a href=\"#并发模型\" class=\"headerlink\" title=\"并发模型\"></a>并发模型</h1><h2 id=\"加锁\"><a href=\"#加锁\" class=\"headerlink\" title=\"加锁\"></a>加锁</h2><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> total <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    sync.Mutex</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">value</span> <span class=\"keyword\">int</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">通过sync.<span class=\"keyword\">lock</span>()和sync.Done()</span><br></pre></td></tr></table></figure>\n<h2 id=\"原子\"><a href=\"#原子\" class=\"headerlink\" title=\"原子\"></a>原子</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">\"sync\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">\"sync/atomic\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\">//用法：</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">worker</span><span class=\"params\">(wg *sync.WaitGroup)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">defer</span> wg.Done()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> i <span class=\"keyword\">uint64</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">100</span>; i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        atomic.AddUint64(&amp;total, i)</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> wg sync.WaitGroup</span><br><span class=\"line\"></span><br><span class=\"line\">    wg.Add(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">go</span> worker(&amp;wg)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">go</span> worker(&amp;wg)</span><br><span class=\"line\"></span><br><span class=\"line\">    wg.Wait()</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"单例\"><a href=\"#单例\" class=\"headerlink\" title=\"单例\"></a>单例</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">我们可以将通用的代码提取出来，就成了标准库中sync.Once的实现：</span><br><span class=\"line\">type Once struct &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    m    Mutex</span><br><span class=\"line\"></span><br><span class=\"line\">    done uint32</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func (o *Once) <span class=\"keyword\">Do</span>(f func()) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> atomic.LoadUint32(&amp;o.done) == 1 &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        return</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    o.m.Lock()</span><br><span class=\"line\"></span><br><span class=\"line\">    defer o.m.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> o.done == 0 &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        defer atomic.StoreUint32(&amp;o.done, 1)</span><br><span class=\"line\"></span><br><span class=\"line\">        f()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">基于sync.Once重新实现单件模式：</span><br><span class=\"line\">var (</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>*singleton</span><br><span class=\"line\"></span><br><span class=\"line\">    once     sync.Once</span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func Instance() *singleton &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    once.<span class=\"keyword\">Do</span>(func() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"built_in\"> instance </span>= &amp;singleton&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    return instance</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"带缓冲chan\"><a href=\"#带缓冲chan\" class=\"headerlink\" title=\"带缓冲chan\"></a>带缓冲chan</h2><p>测试了下才知道原来<br>&lt;-chan int  像这样的只能接收值<br>chan&lt;- int  像这样的只能发送值<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> limit = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> _, w := <span class=\"keyword\">range</span> work &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            limit &lt;- <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">            w()</span><br><span class=\"line\"></span><br><span class=\"line\">            &lt;-limit</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">select</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    done := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">10</span>) <span class=\"comment\">// 带 10 个缓存</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 开N个后台打印线程</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">cap</span>(done); i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            fmt.Println(<span class=\"string\">\"你好, 世界\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">            done &lt;- <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 等待N个后台线程完成</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">cap</span>(done); i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;-done</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//其实也可以用</span></span><br><span class=\"line\">sync.WaitGroup</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"select\"><a href=\"#select\" class=\"headerlink\" title=\"select\"></a>select</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基于<span class=\"keyword\">select</span>实现的管道的超时判断：</span><br><span class=\"line\">    <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> v := &lt;-in:</span><br><span class=\"line\"></span><br><span class=\"line\">        fmt.Println(v)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> &lt;-time.After(time.Second):</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"comment\">// 超时</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">通过<span class=\"keyword\">select</span>的<span class=\"keyword\">default</span>分支实现非阻塞的管道发送或接收操作：</span><br><span class=\"line\">    <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> v := &lt;-in:</span><br><span class=\"line\"></span><br><span class=\"line\">        fmt.Println(v)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 没有数据</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">通过<span class=\"keyword\">select</span>来阻止main函数退出：</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// do some thins</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">select</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>但是管道的发送操作和接收操作是一一对应的，如果要停止多个Goroutine那么可能需要创建同样数量的管道，这个代价太大了。其实我们可以通过close关闭一个管道来实现广播的效果，所有从关闭管道接收的操作均会收到一个零值和一个可选的失败标志。<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">worker</span><span class=\"params\">(cannel <span class=\"keyword\">chan</span> <span class=\"keyword\">bool</span>)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">            fmt.Println(<span class=\"string\">\"hello\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 正常工作</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">case</span> &lt;-cannel:</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 退出</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    cancel := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">bool</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">go</span> worker(cancel)</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    time.Sleep(time.Second)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">close</span>(cancel)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"异常\"><a href=\"#异常\" class=\"headerlink\" title=\"异常\"></a>异常</h1><p>异常必须放在defer func () {}()</p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-04-memory.html\" target=\"_blank\" rel=\"noopener\">https://books.studygolang.com/advanced-go-programming-book/ch2-cgo/ch2-04-memory.html</a></p>\n<h1 id=\"数组\"><a href=\"#数组\" class=\"headerlink\" title=\"数组\"></a>数组</h1><h2 id=\"数组定义方式\"><a href=\"#数组定义方式\" class=\"headerlink\" title=\"数组定义方式\"></a>数组定义方式</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> [<span class=\"number\">3</span>]int                    <span class=\"comment\">// 定义一个长度为3的int类型数组, 元素全部为0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">b</span> = [...]int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;       <span class=\"comment\">// 定义一个长度为3的int类型数组, 元素为 1, 2, 3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> c = [...]int&#123;<span class=\"number\">2</span>: <span class=\"number\">3</span>, <span class=\"number\">1</span>: <span class=\"number\">2</span>&#125;    <span class=\"comment\">// 定义一个长度为3的int类型数组, 元素为 0, 2, 3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> d = [...]int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">4</span>: <span class=\"number\">5</span>, <span class=\"number\">6</span>&#125; <span class=\"comment\">// 定义一个长度为6的int类型数组, 元素为 1, 2, 0, 0, 5, 6</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"数组指针\"><a href=\"#数组指针\" class=\"headerlink\" title=\"数组指针\"></a>数组指针</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> = [...]int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125; <span class=\"comment\">// a 是一个数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">b</span> = &amp;<span class=\"selector-tag\">a</span>                <span class=\"comment\">// b 是指向数组的指针</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"selector-tag\">a</span>[<span class=\"number\">0</span>], <span class=\"selector-tag\">a</span>[<span class=\"number\">1</span>])   <span class=\"comment\">// 打印数组的前2个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"selector-tag\">b</span>[<span class=\"number\">0</span>], <span class=\"selector-tag\">b</span>[<span class=\"number\">1</span>])   <span class=\"comment\">// 通过数组指针访问数组元素的方式和数组类似</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> <span class=\"selector-tag\">i</span>, v := range <span class=\"selector-tag\">b</span> &#123;     <span class=\"comment\">// 通过数组指针迭代数组的元素</span></span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Println(<span class=\"selector-tag\">i</span>, v)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"数组遍历\"><a href=\"#数组遍历\" class=\"headerlink\" title=\"数组遍历\"></a>数组遍历</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"keyword\">range</span> a &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"b[%d]: %d\\n\"</span>, i, b[i])</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i, v := <span class=\"keyword\">range</span> b &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"b[%d]: %d\\n\"</span>, i, v)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(c); i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">\"b[%d]: %d\\n\"</span>, i, b[i])</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"函数数组、管道数组\"><a href=\"#函数数组、管道数组\" class=\"headerlink\" title=\"函数数组、管道数组\"></a>函数数组、管道数组</h2><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 图像解码器数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> decoder1 [<span class=\"number\">2</span>]func(io.Reader) (image<span class=\"selector-class\">.Image</span>, error)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> decoder2 = [...]func(io.Reader) (image<span class=\"selector-class\">.Image</span>, error)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    png<span class=\"selector-class\">.Decode</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">    jpeg<span class=\"selector-class\">.Decode</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 接口数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> unknown1 [<span class=\"number\">2</span>]interface&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> unknown2 = [...]interface&#123;&#125;&#123;<span class=\"number\">123</span>, <span class=\"string\">\"你好\"</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 管道数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> chanList = [<span class=\"number\">2</span>]chan int&#123;&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"空数组\"><a href=\"#空数组\" class=\"headerlink\" title=\"空数组\"></a>空数组</h2><p>长度为0的数组在内存中并不占用空间。空数组虽然很少直接使用，但是可以用于强调某种特有类型的操作时避免分配额外的内存空间，比如用于管道的同步操作：<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c1 := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> [<span class=\"number\">0</span>]<span class=\"keyword\">int</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"c1\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    c1 &lt;- [<span class=\"number\">0</span>]<span class=\"keyword\">int</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;-c1</span><br></pre></td></tr></table></figure></p>\n<p>在这里，我们并不关心管道中传输数据的真实类型，其中管道接收和发送操作只是用于消息的同步。对于这种场景，我们用空数组来作为管道类型可以减少管道元素赋值时的开销。当然一般更倾向于用无类型的匿名结构体代替：<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">c2 := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">struct</span>&#123;&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"c2\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    c2 &lt;- <span class=\"keyword\">struct</span>&#123;&#125;&#123;&#125; <span class=\"comment\">// struct&#123;&#125;部分是类型, &#123;&#125;表示对应的结构体值</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;-c2</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"字符串\"><a href=\"#字符串\" class=\"headerlink\" title=\"字符串\"></a>字符串</h1><h2 id=\"类似切片\"><a href=\"#类似切片\" class=\"headerlink\" title=\"类似切片\"></a>类似切片</h2><p>字符串虽然不是切片，但是支持切片操作，不同位置的切片底层也访问的同一块内存数据（因为字符串是只读的，相同的字符串面值常量通常是对应同一个字符串常量）：<br><figure class=\"highlight makefile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s := <span class=\"string\">\"hello, world\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">hello := s[:5]</span><br><span class=\"line\"></span><br><span class=\"line\">world := s[7:]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">s1 := <span class=\"string\">\"hello, world\"</span>[:5]</span><br><span class=\"line\"></span><br><span class=\"line\">s2 := <span class=\"string\">\"hello, world\"</span>[7:]</span><br></pre></td></tr></table></figure></p>\n<p>和数组一样，内置的len和cap函数返回相同的结果，都对应字符串的长度。也可以通过reflect.StringHeader结构访问字符串的长度（这里只是为了演示字符串的结构，并不是推荐的做法）：<br><figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fmt.Println(<span class=\"string\">\"len(s):\"</span>, (*reflect.StringHeader)(unsafe.Pointer(<span class=\"meta\">&amp;s)).Len)   <span class=\"comment\">// 12</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"len(s1):\"</span>, (*reflect.StringHeader)(unsafe.Pointer(<span class=\"meta\">&amp;s1)).Len) <span class=\"comment\">// 5</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">fmt.Println(<span class=\"string\">\"len(s2):\"</span>, (*reflect.StringHeader)(unsafe.Pointer(<span class=\"meta\">&amp;s2)).Len) <span class=\"comment\">// 5</span></span></span><br></pre></td></tr></table></figure></p>\n<h1 id=\"切片-slice\"><a href=\"#切片-slice\" class=\"headerlink\" title=\"切片(slice)\"></a>切片(slice)</h1><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> (</span><br><span class=\"line\"></span><br><span class=\"line\">    a []<span class=\"keyword\">int</span>               <span class=\"comment\">// nil切片, 和 nil 相等, 一般用来表示一个不存在的切片</span></span><br><span class=\"line\"></span><br><span class=\"line\">    b = []<span class=\"keyword\">int</span>&#123;&#125;           <span class=\"comment\">// 空切片, 和 nil 不相等, 一般用来表示一个空的集合</span></span><br><span class=\"line\"></span><br><span class=\"line\">    c = []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;    <span class=\"comment\">// 有3个元素的切片, len和cap都为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    d = c[:<span class=\"number\">2</span>]             <span class=\"comment\">// 有2个元素的切片, len为2, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    e = c[<span class=\"number\">0</span>:<span class=\"number\">2</span>:<span class=\"built_in\">cap</span>(c)]     <span class=\"comment\">// 有2个元素的切片, len为2, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    f = c[:<span class=\"number\">0</span>]             <span class=\"comment\">// 有0个元素的切片, len为0, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    g = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">3</span>)    <span class=\"comment\">// 有3个元素的切片, len和cap都为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    h = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>) <span class=\"comment\">// 有2个元素的切片, len为2, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    i = <span class=\"built_in\">make</span>([]<span class=\"keyword\">int</span>, <span class=\"number\">0</span>, <span class=\"number\">3</span>) <span class=\"comment\">// 有0个元素的切片, len为0, cap为3</span></span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"string\">``</span></span><br><span class=\"line\">## 添加切片</span><br></pre></td></tr></table></figure>\n<p>var a []int</p>\n<p>a = append(a, 1)               // 追加1个元素</p>\n<p>a = append(a, 1, 2, 3)         // 追加多个元素, 手写解包方式</p>\n<p>a = append(a, []int{1,2,3}…) // 追加一个切片, 切片需要解包</p>\n<figure class=\"highlight clean\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`在容量不足的情况下，append的操作会导致重新分配内存，从而导致巨大的内存分配和复制数据代价`</span><br></pre></td></tr></table></figure>\n<p>var a = []int{1,2,3}</p>\n<p>a = append([]int{0}, a…)        // 在开头添加1个元素</p>\n<p>a = append([]int{-3,-2,-1}, a…) // 在开头添加1个切片<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">```</span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> []int</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], append([]int&#123;x&#125;, <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]...)...)     <span class=\"comment\">// 在第i个位置插入x</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], append([]int&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;, <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]...)...) <span class=\"comment\">// 在第i个位置插入切片</span></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>, x...)       <span class=\"comment\">// 为x切片扩展足够的空间</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i+len(x)</span></span>:], <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]) <span class=\"comment\">// a[i:]向后移动len(x)个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i:], x)</span></span>            <span class=\"comment\">// 复制新添加的切片</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"删除切片\"><a href=\"#删除切片\" class=\"headerlink\" title=\"删除切片\"></a>删除切片</h2><p>需要重新赋值切片防止内存泄漏<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">FindPhoneNumber</span><span class=\"params\">(filename <span class=\"keyword\">string</span>)</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    b, _ := ioutil.ReadFile(filename)</span><br><span class=\"line\"></span><br><span class=\"line\">    b = regexp.MustCompile(<span class=\"string\">\"[0-9]+\"</span>).Find(b)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">append</span>([]<span class=\"keyword\">byte</span>&#123;&#125;, b...) <span class=\"comment\">// 这里</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>删除切片有时候会影响GC<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> []*int&#123; ... &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:len(a)-<span class=\"number\">1</span>]    <span class=\"comment\">// 本删除的最后一个元素依然被引用, 可能导致GC操作被阻碍</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">var</span> <span class=\"selector-tag\">a</span> []*int&#123; ... &#125;</span><br><span class=\"line\"><span class=\"selector-tag\">a</span>[len(a)-<span class=\"number\">1</span>] = nil <span class=\"comment\">// GC回收最后一个元素内存</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:len(a)-<span class=\"number\">1</span>]  <span class=\"comment\">// 从切片删除最后一个元素</span></span><br></pre></td></tr></table></figure></p>\n<p>可以用copy和append组合可以避免创建中间的临时切片，同样是完成添加元素的操作：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>, <span class=\"number\">0</span>)     <span class=\"comment\">// 切片扩展1个空间</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i+<span class=\"number\">1</span>:], a[i:])</span></span> <span class=\"comment\">// a[i:]向后移动1个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">s[i] = x             <span class=\"comment\">// 设置新添加的元素</span></span><br></pre></td></tr></table></figure></p>\n<p>第一句append用于扩展切片的长度，为要插入的元素留出空间。第二句copy操作将要插入位置开始之后的元素向后挪动一个位置。第三句真实地将新添加的元素赋值到对应的位置。操作语句虽然冗长了一点，但是相比前面的方法，可以减少中间创建的临时切片。<br>用copy和append组合也可以实现在中间位置插入多个元素(也就是插入一个切片):<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>, x...)       <span class=\"comment\">// 为x切片扩展足够的空间</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i+len(x)</span></span>:], <span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:]) <span class=\"comment\">// a[i:]向后移动len(x)个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">copy</span><span class=\"params\">(a[i:], x)</span></span>            <span class=\"comment\">// 复制新添加的切片</span></span><br></pre></td></tr></table></figure></p>\n<p>也可以用copy完成删除开头的元素：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = []int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>, <span class=\"selector-tag\">a</span>[<span class=\"number\">1</span>:])] <span class=\"comment\">// 删除开头1个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>, <span class=\"selector-tag\">a</span>[N:])] <span class=\"comment\">// 删除开头N个元素</span></span><br></pre></td></tr></table></figure></p>\n<p>对于删除中间的元素，需要对剩余的元素进行一次整体挪动，同样可以用append或copy原地完成：<br><figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">a</span> = []int&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, ...&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], <span class=\"selector-tag\">a</span>[i+<span class=\"number\">1</span>:]...) <span class=\"comment\">// 删除中间1个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = append(<span class=\"selector-tag\">a</span>[:i], <span class=\"selector-tag\">a</span>[i+N:]...) <span class=\"comment\">// 删除中间N个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:], <span class=\"selector-tag\">a</span>[i+<span class=\"number\">1</span>:])]  <span class=\"comment\">// 删除中间1个元素</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">a</span> = <span class=\"selector-tag\">a</span>[:copy(<span class=\"selector-tag\">a</span>[<span class=\"selector-tag\">i</span>:], <span class=\"selector-tag\">a</span>[i+N:])]  <span class=\"comment\">// 删除中间N个元素</span></span><br></pre></td></tr></table></figure></p>\n<h1 id=\"并发模型\"><a href=\"#并发模型\" class=\"headerlink\" title=\"并发模型\"></a>并发模型</h1><h2 id=\"加锁\"><a href=\"#加锁\" class=\"headerlink\" title=\"加锁\"></a>加锁</h2><figure class=\"highlight cs\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> total <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    sync.Mutex</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">value</span> <span class=\"keyword\">int</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">通过sync.<span class=\"keyword\">lock</span>()和sync.Done()</span><br></pre></td></tr></table></figure>\n<h2 id=\"原子\"><a href=\"#原子\" class=\"headerlink\" title=\"原子\"></a>原子</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">\"sync\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">\"sync/atomic\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\">//用法：</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">worker</span><span class=\"params\">(wg *sync.WaitGroup)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">defer</span> wg.Done()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> i <span class=\"keyword\">uint64</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">100</span>; i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        atomic.AddUint64(&amp;total, i)</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> wg sync.WaitGroup</span><br><span class=\"line\"></span><br><span class=\"line\">    wg.Add(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">go</span> worker(&amp;wg)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">go</span> worker(&amp;wg)</span><br><span class=\"line\"></span><br><span class=\"line\">    wg.Wait()</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"单例\"><a href=\"#单例\" class=\"headerlink\" title=\"单例\"></a>单例</h2><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">我们可以将通用的代码提取出来，就成了标准库中sync.Once的实现：</span><br><span class=\"line\">type Once struct &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    m    Mutex</span><br><span class=\"line\"></span><br><span class=\"line\">    done uint32</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func (o *Once) <span class=\"keyword\">Do</span>(f func()) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> atomic.LoadUint32(&amp;o.done) == 1 &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        return</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    o.m.Lock()</span><br><span class=\"line\"></span><br><span class=\"line\">    defer o.m.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> o.done == 0 &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        defer atomic.StoreUint32(&amp;o.done, 1)</span><br><span class=\"line\"></span><br><span class=\"line\">        f()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">基于sync.Once重新实现单件模式：</span><br><span class=\"line\">var (</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"built_in\"> instance </span>*singleton</span><br><span class=\"line\"></span><br><span class=\"line\">    once     sync.Once</span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">func Instance() *singleton &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    once.<span class=\"keyword\">Do</span>(func() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"built_in\"> instance </span>= &amp;singleton&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    return instance</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"带缓冲chan\"><a href=\"#带缓冲chan\" class=\"headerlink\" title=\"带缓冲chan\"></a>带缓冲chan</h2><p>测试了下才知道原来<br>&lt;-chan int  像这样的只能接收值<br>chan&lt;- int  像这样的只能发送值<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> limit = <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> _, w := <span class=\"keyword\">range</span> work &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            limit &lt;- <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">            w()</span><br><span class=\"line\"></span><br><span class=\"line\">            &lt;-limit</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">select</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    done := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">int</span>, <span class=\"number\">10</span>) <span class=\"comment\">// 带 10 个缓存</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 开N个后台打印线程</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">cap</span>(done); i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">go</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            fmt.Println(<span class=\"string\">\"你好, 世界\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">            done &lt;- <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 等待N个后台线程完成</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">cap</span>(done); i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;-done</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//其实也可以用</span></span><br><span class=\"line\">sync.WaitGroup</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"select\"><a href=\"#select\" class=\"headerlink\" title=\"select\"></a>select</h2><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基于<span class=\"keyword\">select</span>实现的管道的超时判断：</span><br><span class=\"line\">    <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> v := &lt;-in:</span><br><span class=\"line\"></span><br><span class=\"line\">        fmt.Println(v)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> &lt;-time.After(time.Second):</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"comment\">// 超时</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">通过<span class=\"keyword\">select</span>的<span class=\"keyword\">default</span>分支实现非阻塞的管道发送或接收操作：</span><br><span class=\"line\">    <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> v := &lt;-in:</span><br><span class=\"line\"></span><br><span class=\"line\">        fmt.Println(v)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 没有数据</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">通过<span class=\"keyword\">select</span>来阻止main函数退出：</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// do some thins</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">select</span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>但是管道的发送操作和接收操作是一一对应的，如果要停止多个Goroutine那么可能需要创建同样数量的管道，这个代价太大了。其实我们可以通过close关闭一个管道来实现广播的效果，所有从关闭管道接收的操作均会收到一个零值和一个可选的失败标志。<br><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">worker</span><span class=\"params\">(cannel <span class=\"keyword\">chan</span> <span class=\"keyword\">bool</span>)</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">select</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\"></span><br><span class=\"line\">            fmt.Println(<span class=\"string\">\"hello\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 正常工作</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">case</span> &lt;-cannel:</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 退出</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    cancel := <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">bool</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++ &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">go</span> worker(cancel)</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    time.Sleep(time.Second)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">close</span>(cancel)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"异常\"><a href=\"#异常\" class=\"headerlink\" title=\"异常\"></a>异常</h1><p>异常必须放在defer func () {}()</p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cji9tizhh0001b5wxzhsgfk5a","category_id":"cji9tizhq0005b5wxyvmnu8n2","_id":"cji9tizhw0009b5wx0dlzlk9i"},{"post_id":"cji9tizhl0003b5wxpmqrrv04","category_id":"cji9tizhv0007b5wxv3hqtpu3","_id":"cji9tizhx000bb5wxiuawad2u"},{"post_id":"cji9tizi3000db5wxud4b4o1t","category_id":"cji9tizhq0005b5wxyvmnu8n2","_id":"cji9tizi4000fb5wxvrrka5cd"}],"PostTag":[{"post_id":"cji9tizhl0003b5wxpmqrrv04","tag_id":"cji9tizhv0006b5wx8f58rovm","_id":"cji9tizhx000ab5wxu2qgoyfi"},{"post_id":"cji9tizhl0003b5wxpmqrrv04","tag_id":"cji9tizhw0008b5wxsfmegvze","_id":"cji9tizhx000cb5wxperbc5ou"},{"post_id":"cji9tizi3000db5wxud4b4o1t","tag_id":"cji9tizi4000eb5wx8x3kcqne","_id":"cji9tizi5000gb5wxhk0h8fq7"}],"Tag":[{"name":"Redis","_id":"cji9tizhv0006b5wx8f58rovm"},{"name":"技术栈","_id":"cji9tizhw0008b5wxsfmegvze"},{"name":"Go","_id":"cji9tizi4000eb5wx8x3kcqne"}]}}